---
title: "Downscaling Analysis: Variable Importance and Effects"
format:
  html:
    self-contained: false
    df-print: paged
    toc: true
execute:
  freeze: false   # force re-execution to refresh figures after new model runs
---

# Overview
This page answers two questions for each model (pool × PFT):

1) Which predictors matter most? (Top-5 table across ensembles)
2) How do top predictors affect predictions? (PDP panels)

Notes: importance is aggregated across ensembles; PDPs come from one saved RF model and are for quick intuition. ALE/ICE details are folded at the bottom.
 
```{r, include=FALSE}
options(ccmmf.quiet_banner = TRUE)
source(here::here("000-config.R"))

summ_vi <- function(pft, pool, top_n = 5) {
  spec_key <- paste0(janitor::make_clean_names(pft), "_", janitor::make_clean_names(pool))
  vi_file <- file.path(model_outdir, paste0("vi_", spec_key, "_by_ensemble.csv"))
  if (!file.exists(vi_file)) return(NULL)
  readr::read_csv(vi_file, show_col_types = FALSE) |>
    group_by(pft, model_output, predictor) |>
    summarize(
      median_importance = median(importance, na.rm = TRUE),
      iqr_importance = IQR(importance, na.rm = TRUE),
      .groups = "drop"
    ) |>
    arrange(desc(median_importance)) |>
    slice_head(n = top_n)
}

pfts <- c("annual crop", "woody perennial crop")
```

# TotSoilCarb

#### Annual crop

[![Annual crop – TotSoilCarb: importance + PDP](../figures/annual_crop_tot_soil_carb_importance_partial_plots.png){width=100%}](../figures/annual_crop_tot_soil_carb_importance_partial_plots.png)

#### Woody perennial crop

[![Woody perennial crop – TotSoilCarb: importance + PDP](../figures/woody_perennial_crop_tot_soil_carb_importance_partial_plots.png){width=100%}](../figures/woody_perennial_crop_tot_soil_carb_importance_partial_plots.png)


# AGB

#### Annual crop

[![Annual crop – AGB: importance + PDP](../figures/annual_crop_agb_importance_partial_plots.png){width=100%}](../figures/annual_crop_agb_importance_partial_plots.png)

#### Woody perennial crop

[![Woody perennial crop – AGB: importance + PDP](../figures/woody_perennial_crop_agb_importance_partial_plots.png){width=100%}](../figures/woody_perennial_crop_agb_importance_partial_plots.png)

<!-- ALE/ICE plots omitted to focus on the partial dependence. -->
