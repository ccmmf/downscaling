---
title: "Downscaling Results and Analysis"
author: "David LeBauer"
date: today
format:
  html:
    self-contained: false
    df-print: default
    toc: true
execute:
  echo: false
---



# Overview

Here we present results of aggregating from field scale pool sizes <!-- and fluxes--> to county-level estimates of county-level carbon stocks and densities for soil carbon stocks to 30cm and aboveground biomass.

**Not validated, for illustrative purposes only.**

For detailed information about methods and workflow, see the [Workflow Documentation](../docs/workflow_documentation.md).

Estimates for woody and mixed woody + annual systems are done for all fields in the LandIQ dataset with tree and vinyard crops; estimates for annual systems are done for all fields with herbaceous annual crops.

In the mixed scenario, ground cover is planted in all orchards. The methods for simulating the addition of ground cover to orchards are described in [Mixed System Prototype](../docs/mixed_system_prototype.qmd). Briefly, it combines downscaled model outputs from the woody perennial crop and annual crop PFTs to represent the effect of ground cover on carbon pools.

# Results

## County-Level Carbon Stocks and Densities

The maps below are organized to compare across PFTs. First we show total county carbon (Stocks, Tg), then area‑normalized density (Density, Mg/ha), each split by carbon pool and PFT.

### Stocks

#### Soil Carbon (TotSoilCarb)

##### Annual Crop

![](../figures/county_annual_crop_TotSoilCarb_carbon_stock.webp)

##### Woody Perennial Crop (Orchards & Vineyards)

![](../figures/county_woody_perennial_crop_TotSoilCarb_carbon_stock.webp)

##### Woody + Annual (Orchards & Vineyards with Ground Cover)

![](../figures/county_woody_annual_TotSoilCarb_carbon_stock.webp)

#### Aboveground Biomass (AGB)

##### Annual Crop

![](../figures/county_annual_crop_AGB_carbon_stock.webp)

##### Woody Perennial Crop (Orchards & Vineyards)

![](../figures/county_woody_perennial_crop_AGB_carbon_stock.webp)

##### Woody + Annual (Orchards & Vineyards with Ground Cover)

![](../figures/county_woody_annual_AGB_carbon_stock.webp)

### Density

#### Soil Carbon (TotSoilCarb)

##### Annual Crop

![](../figures/county_annual_crop_TotSoilCarb_carbon_density.webp)

##### Woody Perennial Crop (Orchards & Vineyards)

![](../figures/county_woody_perennial_crop_TotSoilCarb_carbon_density.webp)

##### Woody + Annual (Orchards & Vineyards with Ground Cover)
![](../figures/county_woody_annual_TotSoilCarb_carbon_density.webp)

#### Aboveground Biomass (AGB)

##### Annual Crop

![](../figures/county_annual_crop_AGB_carbon_density.webp)

##### Woody Perennial Crop (Orchards & Vineyards)

![](../figures/county_woody_perennial_crop_AGB_carbon_density.webp)

##### Woody + Annual (Orchards & Vineyards with Ground Cover)

![](../figures/county_woody_annual_AGB_carbon_density.webp)

### Tables: County Stocks and Density (by PFT) and PFT Comparison

The first table summarizes county-level metrics for each PFT. The second table pivots carbon pools to highlight differences across cropping systems..

```{r, options, include=FALSE}
options(ccmmf.quiet_banner = TRUE)
source(here::here("000-config.R"))
```

```{r,load_inputs, message=FALSE, warning=FALSE}

# Load county summaries data
county_summaries <- readr::read_csv(
  file.path(model_outdir, "county_summaries.csv"),
  show_col_types = FALSE
)

# Long table with PFT + area
county_summaries_table <- county_summaries |>
  dplyr::mutate(
    `Mean Total C (Tg/county)` = paste0(signif(mean_total_c_Tg, 2), " (", signif(sd_total_c_Tg, 2), ")"),
    `Mean C Density (Mg/ha)`   = paste0(signif(mean_c_density_Mg_ha, 2), " (", signif(sd_c_density_Mg_ha, 2), ")"),
    `Area (ha)`                = signif(mean_total_ha, 3)
  ) |>
  dplyr::rename(
    `Carbon Pool` = model_output,
    `PFT`         = pft,
    `County`      = county,
    `# Fields`    = n
  ) |>
  dplyr::select(`Carbon Pool`, `PFT`, `County`, `# Fields`, `Area (ha)`, `Mean Total C (Tg/county)`, `Mean C Density (Mg/ha)`)

htmlwidgets::setWidgetIdSeed(123)

DT::datatable(
  county_summaries_table,
  extensions = c('Scroller','SearchPanes','Select'),
  options = list(
    dom = 'Plrtip',
    pageLength = 10,
    searchHighlight = FALSE,
    deferRender = TRUE,
    scroller = TRUE,
    scrollY = "60vh",
    searchPanes = list(cascadePanes = TRUE, initCollapsed = TRUE),
    columnDefs = list(list(searchPanes = list(show = TRUE), targets = c(0,1)))
  ),
  class = "stripe hover compact",
  rownames = FALSE, escape = FALSE
)

# Wide comparison: TotSoilCarb density by PFT
density_wide <- county_summaries |>
  dplyr::select(County = county, `Carbon Pool` = model_output, PFT = pft, `C Density (Mg/ha)` = mean_c_density_Mg_ha) |>
  tidyr::pivot_wider(names_from = PFT, values_from = `C Density (Mg/ha)`) |>
  dplyr::arrange(`Carbon Pool`, County)

# Drop rows where the row-wise max value is < MASK_THRESHOLD * colsum of the column where that max occurs,
# evaluated within each Carbon Pool separately
if (exists("MASK_THRESHOLD")) {
  mask_group <- function(df) {
    vals <- as.matrix(dplyr::select(df, -County, -`Carbon Pool`))
    vals2 <- vals; vals2[is.na(vals2)] <- -Inf
    col_sums <- colSums(vals, na.rm = TRUE)
    if (all(!is.finite(col_sums)) || sum(col_sums, na.rm = TRUE) <= 0) return(df)
    row_max_val <- apply(vals2, 1, max)
    row_max_col <- max.col(vals2, ties.method = "first")
    thresholds <- col_sums[row_max_col] * get0("MASK_THRESHOLD", ifnotfound = 0.01)
    keep <- is.finite(row_max_val) & row_max_val >= thresholds
    df[keep, , drop = FALSE]
  }
  density_wide <- density_wide |>
    dplyr::group_split(`Carbon Pool`, .keep = TRUE) |>
    purrr::map(mask_group) |>
    dplyr::bind_rows()
}

DT::datatable(
  density_wide,
  extensions = c('Scroller','SearchPanes','Select'),
  options = list(
    dom = 'Plrtip',
    pageLength = 10,
    searchHighlight = FALSE,
    deferRender = TRUE,
    scroller = TRUE,
    scrollY = "60vh",
    searchPanes = list(cascadePanes = TRUE, initCollapsed = TRUE),
    columnDefs = list(list(searchPanes = list(show = TRUE), targets = c(0,1)))
  ),
  class = "stripe hover compact",
  rownames = FALSE, escape = FALSE
)
```

<!-- 
OMIT - need to find appropriate t0 value for annual AGB 
Or completely omit delta for annual AGB and focus on C in woody biomass 
## Start-to-End Delta by PFT

The following maps show county-level changes (start-to-end) in carbon density and stock for each PFT and pool. Positive values indicate an increase over the modeled period.

### Annual Crop


TotSoilCarb density: ![](../figures/county_delta_annual_crop_TotSoilCarb_carbon_density.webp)

TotSoilCarb stock: ![](../figures/county_delta_annual_crop_TotSoilCarb_carbon_stock.webp)

AGB density: ![](../figures/county_delta_annual_crop_AGB_carbon_density.webp)

AGB stock: ![](../figures/county_delta_annual_crop_AGB_carbon_stock.webp)

### Woody Perennial Crop

TotSoilCarb density: ![](../figures/county_delta_woody_perennial_crop_TotSoilCarb_carbon_density.webp)

TotSoilCarb stock: ![](../figures/county_delta_woody_perennial_crop_TotSoilCarb_carbon_stock.webp)

AGB density: ![](../figures/county_delta_woody_perennial_crop_AGB_carbon_density.webp)

AGB stock: ![](../figures/county_delta_woody_perennial_crop_AGB_carbon_stock.webp)

### Per-county Mixed-Woody Differences (Tables)

```{r}
# Compute Mixed – Woody differences from matched fields for both pools
dp <- vroom::vroom(
  file.path(model_outdir, "downscaled_preds.csv"),
  col_types = readr::cols(
    site_id = readr::col_character(),
    pft = readr::col_character(),
    ensemble = readr::col_double(),
    c_density_Mg_ha = readr::col_double(),
    total_c_Mg = readr::col_double(),
    area_ha = readr::col_double(),
    county = readr::col_character(),
    model_output = readr::col_character()
  )
)
mix <- dp |> dplyr::filter(pft == "woody + annual") |>
  dplyr::select(site_id, ensemble, model_output, county, total_c_Mg_mix = total_c_Mg)
wood <- dp |> dplyr::filter(pft == "woody perennial crop") |>
  dplyr::select(site_id, ensemble, model_output, county, total_c_Mg_woody = total_c_Mg)
diff_tbl <- mix |>
  dplyr::inner_join(wood, by = c("site_id","ensemble","model_output","county")) |>
  dplyr::mutate(diff_total_Mg = total_c_Mg_mix - total_c_Mg_woody) |>
  dplyr::group_by(model_output, county, ensemble) |>
  dplyr::summarise(diff_total_Mg = sum(diff_total_Mg), .groups = "drop") |>
  dplyr::group_by(model_output, county) |>
  dplyr::summarise(delta_Tg = PEcAn.utils::ud_convert(mean(diff_total_Mg), "Mg", "Tg"), .groups = "drop") |>
  dplyr::mutate(`Delta Total C (Tg)` = ifelse(abs(delta_Tg) < 0.005, 0, round(delta_Tg, 3))) |>
  dplyr::select(model_output, county, `Delta Total C (Tg)`) |>
  dplyr::arrange(model_output, county)

DT::datatable(
  diff_tbl,
  extensions = c('Scroller','SearchPanes','Select'),
  options = list(
    dom = 'Plrtip',
    pageLength = 10,
    searchHighlight = FALSE,
    deferRender = TRUE,
    scroller = TRUE,
    scrollY = "60vh",
    searchPanes = list(cascadePanes = TRUE, initCollapsed = TRUE),
    columnDefs = list(list(searchPanes = list(show = TRUE), targets = c(0,1)))
  ),
  class = "stripe hover compact",
  rownames = FALSE, escape = FALSE
)
```


### Per-county Start-to-End Deltas

```{r}
delta_csv <- file.path(model_outdir, "downscaled_deltas.csv")
if (file.exists(delta_csv)) {
  deltas <- vroom::vroom(
    delta_csv,
    col_types = readr::cols(
      site_id = readr::col_character(),
      pft = readr::col_character(),
      ensemble = readr::col_double(),
      delta_c_density_Mg_ha = readr::col_double(),
      delta_total_c_Mg = readr::col_double(),
      area_ha = readr::col_double(),
      county = readr::col_character(),
      model_output = readr::col_character()
    )
  )
  delta_tbl <- deltas |>
    dplyr::group_by(model_output, pft, county, ensemble) |>
    dplyr::summarise(total_delta_Mg = sum(delta_total_c_Mg), total_ha = sum(area_ha), .groups = "drop") |>
    dplyr::mutate(`Delta Density (Mg/ha)` = total_delta_Mg / total_ha,
                   `Delta Total (Tg)` = PEcAn.utils::ud_convert(total_delta_Mg, "Mg", "Tg")) |>
    dplyr::group_by(model_output, pft, county) |>
    dplyr::summarise(`Delta Density (Mg/ha)` = mean(`Delta Density (Mg/ha)`),
                     `Delta Total (Tg)` = mean(`Delta Total (Tg)`), .groups = "drop") |>
    dplyr::mutate(`Delta Density (Mg/ha)` = round(`Delta Density (Mg/ha)`, 4),
                   `Delta Total (Tg)` = round(`Delta Total (Tg)`, 3)) |>
    dplyr::rename(`Carbon Pool` = model_output, `PFT` = pft, County = county) |>
    dplyr::arrange(`Carbon Pool`, `PFT`, County)

  DT::datatable(
    delta_tbl,
    extensions = c('Scroller','SearchPanes','Select'),
    options = list(
      dom = 'Plrtip',
      pageLength = 10,
      searchHighlight = FALSE,
      deferRender = TRUE,
      scroller = TRUE,
      scrollY = "60vh",
      searchPanes = list(cascadePanes = TRUE, initCollapsed = TRUE),
      columnDefs = list(list(searchPanes = list(show = TRUE), targets = c(0,1,2)))
    ),
    class = "stripe hover compact",
    rownames = FALSE, escape = FALSE
  )
} else {
  cat("Delta file not found.")
}
```
-->