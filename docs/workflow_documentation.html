<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David LeBauer">

<title>Downscaling - Technical Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Technical Documentation</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Downscaling</a> 
        <div class="sidebar-tools-main">
    <a href="" title="Status: Draft" class="sidebar-tool px-1"><i class="bi bi-exclamation-octagon"></i></a>
    <a href="https://github.com/ccmmf/downscaling" title="" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Reports</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reports/downscaling_results.html" class="sidebar-item-text sidebar-link">Downscaling Results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reports/design_points_analysis.html" class="sidebar-item-text sidebar-link">Design Points Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reports/variable_importance.html" class="sidebar-item-text sidebar-link">Downscaling Model Evaluation</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Docs</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/workflow_documentation.html" class="sidebar-item-text sidebar-link active">Technical Documentation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/mixed_system_prototype.html" class="sidebar-item-text sidebar-link">Mixed System Prototype</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#terminology" id="toc-terminology" class="nav-link active" data-scroll-target="#terminology">Terminology</a></li>
  <li><a href="#this-repository-contains-two-workflows-that-will-be-split" id="toc-this-repository-contains-two-workflows-that-will-be-split" class="nav-link" data-scroll-target="#this-repository-contains-two-workflows-that-will-be-split">This Repository Contains Two Workflows That Will Be Split</a></li>
  <li><a href="#workflow-steps" id="toc-workflow-steps" class="nav-link" data-scroll-target="#workflow-steps">Workflow Steps</a>
  <ul class="collapse">
  <li><a href="#configuration" id="toc-configuration" class="nav-link" data-scroll-target="#configuration">Configuration</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">1. Data Preparation</a></li>
  <li><a href="#design-point-selection" id="toc-design-point-selection" class="nav-link" data-scroll-target="#design-point-selection">2. Design Point Selection</a></li>
  <li><a href="#sipnet-model-runs" id="toc-sipnet-model-runs" class="nav-link" data-scroll-target="#sipnet-model-runs">3. SIPNET Model Runs</a></li>
  <li><a href="#extract-sipnet-output" id="toc-extract-sipnet-output" class="nav-link" data-scroll-target="#extract-sipnet-output">4. Extract SIPNET Output</a></li>
  <li><a href="#mixed-cropping-systems" id="toc-mixed-cropping-systems" class="nav-link" data-scroll-target="#mixed-cropping-systems">5. Mixed Cropping Systems</a></li>
  <li><a href="#downscale-aggregate-to-county-and-plot" id="toc-downscale-aggregate-to-county-and-plot" class="nav-link" data-scroll-target="#downscale-aggregate-to-county-and-plot">6. Downscale, Aggregate to County, and Plot</a></li>
  </ul></li>
  <li><a href="#running-on-bu-cluster" id="toc-running-on-bu-cluster" class="nav-link" data-scroll-target="#running-on-bu-cluster">Running on BU Cluster</a></li>
  <li><a href="#documentation-site-quarto" id="toc-documentation-site-quarto" class="nav-link" data-scroll-target="#documentation-site-quarto">Documentation Site (Quarto)</a></li>
  <li><a href="#technical-reference" id="toc-technical-reference" class="nav-link" data-scroll-target="#technical-reference">Technical Reference</a>
  <ul class="collapse">
  <li><a href="#ensemble-structure" id="toc-ensemble-structure" class="nav-link" data-scroll-target="#ensemble-structure">Ensemble Structure</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Technical Documentation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David LeBauer </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>The downscaling workflow predicts carbon pools (Soil Organic Carbon and Aboveground Biomass) for cropland fields in California and then aggregates these predictions to the county scale.</p>
<p>It uses an ensemble-based approach to uncertainty propagation and analysis, maintaining ensemble structure to propagate errors through the prediction and aggregation processes.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figures/spatial_downscaling_workflow.webp" class="img-fluid figure-img" style="width:5in"></p>
<p></p><figcaption class="figure-caption">Spatial downscaling workflow using machine learning with environmental covariates</figcaption><p></p>
</figure>
</div>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<ul>
<li><strong>Design Points</strong>: Fields chosen via stratified random sampling using k-means clustering on environmental data layers across California crop fields.</li>
<li><strong>Crop Fields</strong>: All croplands in the LandIQ dataset.</li>
<li><strong>Anchor Sites:</strong> Sites used as ground truth for calibration and validation, including UC research stations and Ameriflux sites.</li>
</ul>
</section>
<section id="this-repository-contains-two-workflows-that-will-be-split" class="level2">
<h2 class="anchored" data-anchor-id="this-repository-contains-two-workflows-that-will-be-split">This Repository Contains Two Workflows That Will Be Split</h2>
<p>TODO <strong>Workflows (1 &amp; 3) are in this repository and will be split</strong></p>
<p>The workflows are</p>
<ol type="1">
<li><strong>Site Selection</strong>: uses environmental variables (later also management layers) to create clusters and then select representative sites. The design_points.csv are then passed to the ensemble workflow<br>
</li>
<li>Ensemble in ccmmf/workflows repository, generates ensemble outputs</li>
<li><strong>Downscaling</strong>: uses ensemble outputs to make predictions for each field in CA then aggregate to county level summaries.</li>
</ol>
<!--
TODO: Add workflow diagram; should be generated by Targets 
-->
</section>
<section id="workflow-steps" class="level2">
<h2 class="anchored" data-anchor-id="workflow-steps">Workflow Steps</h2>
<section id="configuration" class="level3">
<h3 class="anchored" data-anchor-id="configuration">Configuration</h3>
<p>Workflow settings are configured in <code>000-config.R</code>.</p>
<p>The configuration script reads the CCMMF directory from the environment variable <code>CCMMF_DIR</code> (set in .Renviron), and uses it to define paths for inputs and outputs.</p>
<p>The <code>CCMMF_DIR</code> variable, however, is defined in <code>.Renviron</code> so that it can: - Be used to locate and override R library (<code>RENV_PATHS_LIBRARY</code>) and cache (<code>RENV_PATHS_CACHE</code>) paths outside the home directory. - Be easily overridden via a shell export (<code>export CCMMF_DIR=…</code>) without modifying workflow scripts.</p>
<section id="configuration-setup" class="level4">
<h4 class="anchored" data-anchor-id="configuration-setup">Configuration setup</h4>
<p>To set up this workflow to run on your system, follow the following steps.</p>
<p><strong>Clone Repository</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@github.com:ccmmf/downscaling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>CCMMF_DIR</code> should point to the shared CCMMF directory. This is the location where data, inputs, and outputs will be stored, as well as the location of the <code>renv</code> cache and library</li>
<li><code>RENV_PATHS_CACHE</code> and <code>RENV_PATHS_LIBRARY</code> store the <code>renv</code> cache and library in the CCMMF directory. These are in a subdirectory of the CCMMF directory in order to make them available across all users (and because on some computers, they exceed allocated space in the home directory).</li>
<li><code>R_LIBS_USER</code> must point to the platform and R version specific subdirectory inside <code>RENV_PATHS_LIBRARY</code>.<br>
</li>
<li><code>.Rprofile</code>
<ul>
<li>sets repositories from which R packages are installed</li>
<li>runs <code>renv/activate.R</code></li>
</ul></li>
<li><code>000-config.R</code>
<ul>
<li>set <code>pecan_outdir</code> based on the CCMMF_DIR.</li>
<li>confirm that relative paths (<code>data_raw</code>, <code>data</code>, <code>cache</code>) are correct.</li>
<li>detect and use resources for parallel processing (with future package); default is <code>available cores - 1</code></li>
<li>PRODUCTION mode setting. For testing, set <code>PRODUCTION</code> to <code>FALSE</code>. This is <em>much</em> faster and requires fewer computing resources because it subsets large datasets. Once a test run is successful, set <code>PRODUCTION</code> to <code>TRUE</code> to run the full workflow.</li>
</ul></li>
</ul>
</section>
</section>
<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">1. Data Preparation</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/009_update_landiq.R</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/010_prepare_covariates.R</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/011_prepare_anchor_sites.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These scripts prepare data for clustering and downscaling:</p>
<ul>
<li>Converts LandIQ-derived shapefiles to a geopackage with geospatial information and a CSV with other attributes</li>
<li>Extracts environmental covariates (clay, organic carbon, topographic wetness, temperature, precipitation, solar radiation, vapor pressure)</li>
<li>Groups fields into Cal-Adapt climate regions</li>
<li>Assigns anchor sites to fields</li>
</ul>
<p><strong>Inputs:</strong></p>
<ul>
<li><strong>LandIQ Crop Map</strong>: <code>data_raw/i15_Crop_Mapping_2016_SHP/i15_Crop_Mapping_2016.shp</code></li>
<li><strong>Soilgrids</strong>: <code>clay_0-5cm_mean.tif</code> and <code>ocd_0-5cm_mean.tif</code> Consider aggregating 0-5,5-15,15-30 into a single 0-30 cm layer</li>
<li><strong>TWI</strong>: <code>TWI/TWI_resample.tiff</code></li>
<li><strong>ERA5 Met Data</strong>: Files in <code>GridMET/</code> folder named <code>ERA5_met_&lt;YYYY&gt;.tiff</code></li>
<li><strong>Anchor Sites</strong>: <code>data_raw/anchor_sites.csv</code></li>
</ul>
<p><strong>Outputs:</strong></p>
<ul>
<li><code>ca_fields.gpkg</code>: Spatial information from LandIQ</li>
<li><code>ca_field_attributes.csv</code>: Site attributes including crop type</li>
<li><code>site_covariates.csv</code>: Environmental covariates for each field</li>
<li><code>anchor_sites_ids.csv</code>: Anchor site information</li>
</ul>
<p><strong>Environmental Covariates</strong></p>
<table class="table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
<th>Source</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>temp</td>
<td>Mean annual temperature</td>
<td>ERA5</td>
<td>°C</td>
</tr>
<tr class="even">
<td>precip</td>
<td>Mean annual precipitation</td>
<td>ERA5</td>
<td>mm/year</td>
</tr>
<tr class="odd">
<td>srad</td>
<td>Solar radiation</td>
<td>ERA5</td>
<td>W/m²</td>
</tr>
<tr class="even">
<td>vapr</td>
<td>Vapor pressure deficit</td>
<td>ERA5</td>
<td>kPa</td>
</tr>
<tr class="odd">
<td>clay</td>
<td>Clay content</td>
<td>SoilGrids</td>
<td>%</td>
</tr>
<tr class="even">
<td>ocd</td>
<td>Organic carbon density</td>
<td>SoilGrids</td>
<td>g/kg</td>
</tr>
<tr class="odd">
<td>twi</td>
<td>Topographic wetness index</td>
<td>SRTM-derived</td>
<td>-</td>
</tr>
</tbody>
</table>
</section>
<section id="design-point-selection" class="level3">
<h3 class="anchored" data-anchor-id="design-point-selection">2. Design Point Selection</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/020_cluster_and_select_design_points.R</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/021_clustering_diagnostics.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Uses k-means clustering to select representative fields plus anchor sites:</p>
<ul>
<li>Subsample LandIQ fields and include anchor sites for clustering</li>
<li>Select cluster number based on the Elbow Method</li>
<li>Cluster fields using k-means based on environmental covariates</li>
<li>Select design points from clusters for SIPNET simulation</li>
</ul>
<p><strong>Inputs:</strong> - <code>data/site_covariates.csv</code> - <code>data/anchor_sites_ids.csv</code></p>
<p><strong>Output:</strong> - <code>data/design_points.csv</code></p>
</section>
<section id="sipnet-model-runs" class="level3">
<h3 class="anchored" data-anchor-id="sipnet-model-runs">3. SIPNET Model Runs</h3>
<p>A separate workflow prepares inputs and runs SIPNET simulations for the design points.</p>
<p><strong>Inputs:</strong> - <code>design_points.csv</code> - Initial conditions (from modeling workflow)</p>
<p><strong>Outputs:</strong> - <code>out/ENS-&lt;ensemble_number&gt;-&lt;site_id&gt;/YYYY.nc</code>: NetCDF files containing SIPNET outputs, in PEcAn standard model output format. - <code>out/ENS-&lt;ensemble_number&gt;-&lt;site_id&gt;/YYYY.nc.var</code>: List of variables included in SIPNET output (see table below)</p>
<p><strong>Available Variables</strong></p>
<p>Each output file named <code>YYYY.nc</code> has an associated file named <code>YYYY.nc.var</code>. This file contains a list of variables included in the output. SIPNET outputs have been converted to PEcAn standard units and stored in PEcAn standard NetCDF files. PEcAn standard units are SI, following the Climate Forecasting standards:</p>
<ul>
<li>Mass pools: kg / m2
<ul>
<li>TotSoilCarb: Total Soil Carbon</li>
<li>AbvGrndWood: Above ground woody biomass</li>
</ul></li>
<li>Mass fluxes: kg / m2 / s-1
<ul>
<li>GPP: Gross Primary Productivity</li>
<li>NPP: Net Primary Productivity</li>
</ul></li>
<li>Energy fluxes: W / m2</li>
<li>Other:
<ul>
<li>LAI: m2 / m2</li>
</ul></li>
</ul>
<table class="table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GPP</td>
<td>Gross Primary Productivity</td>
</tr>
<tr class="even">
<td>NPP</td>
<td>Net Primary Productivity</td>
</tr>
<tr class="odd">
<td>TotalResp</td>
<td>Total Respiration</td>
</tr>
<tr class="even">
<td>AutoResp</td>
<td>Autotrophic Respiration</td>
</tr>
<tr class="odd">
<td>HeteroResp</td>
<td>Heterotrophic Respiration</td>
</tr>
<tr class="even">
<td>SoilResp</td>
<td>Soil Respiration</td>
</tr>
<tr class="odd">
<td>NEE</td>
<td>Net Ecosystem Exchange</td>
</tr>
<tr class="even">
<td>AbvGrndWood</td>
<td>Above ground woody biomass</td>
</tr>
<tr class="odd">
<td>leaf_carbon_content</td>
<td>Leaf Carbon Content</td>
</tr>
<tr class="even">
<td>TotLivBiom</td>
<td>Total living biomass</td>
</tr>
<tr class="odd">
<td>TotSoilCarb</td>
<td>Total Soil Carbon</td>
</tr>
<tr class="even">
<td>Qle</td>
<td>Latent heat</td>
</tr>
<tr class="odd">
<td>Transp</td>
<td>Total transpiration</td>
</tr>
<tr class="even">
<td>SoilMoist</td>
<td>Average Layer Soil Moisture</td>
</tr>
<tr class="odd">
<td>SoilMoistFrac</td>
<td>Average Layer Fraction of Saturation</td>
</tr>
<tr class="even">
<td>SWE</td>
<td>Snow Water Equivalent</td>
</tr>
<tr class="odd">
<td>litter_carbon_content</td>
<td>Litter Carbon Content</td>
</tr>
<tr class="even">
<td>litter_mass_content_of_water</td>
<td>Average layer litter moisture</td>
</tr>
<tr class="odd">
<td>LAI</td>
<td>Leaf Area Index</td>
</tr>
<tr class="even">
<td>fine_root_carbon_content</td>
<td>Fine Root Carbon Content</td>
</tr>
<tr class="odd">
<td>coarse_root_carbon_content</td>
<td>Coarse Root Carbon Content</td>
</tr>
<tr class="even">
<td>GWBI</td>
<td>Gross Woody Biomass Increment</td>
</tr>
<tr class="odd">
<td>AGB</td>
<td>Total aboveground biomass</td>
</tr>
<tr class="even">
<td>time_bounds</td>
<td>history time interval endpoints</td>
</tr>
</tbody>
</table>
</section>
<section id="extract-sipnet-output" class="level3">
<h3 class="anchored" data-anchor-id="extract-sipnet-output">4. Extract SIPNET Output</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/030_extract_sipnet_output.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Extracts and formats SIPNET outputs for downscaling:</p>
<ul>
<li>Extract output variables (AGB, TotSoilCarb) from SIPNET simulations</li>
<li>Aggregate site-level ensemble outputs into long and 4D array formats</li>
<li>Save CSV and NetCDF files following EFI standards</li>
</ul>
<p><strong>Inputs:</strong> - <code>out/ENS-&lt;ensemble_number&gt;-&lt;site_id&gt;/YYYY.nc</code></p>
<p><strong>Outputs:</strong> - <code>out/ensemble_output.csv</code>: Long format data</p>
</section>
<section id="mixed-cropping-systems" class="level3">
<h3 class="anchored" data-anchor-id="mixed-cropping-systems">5. Mixed Cropping Systems</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/031_aggregate_sipnet_output.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Simulates mixed-cropping scenarios by combining outputs across two PFTs using a mixed aggregation function (see Mixed System Prototype). Two methods are supported:</p>
<ul>
<li>weighted: area-partitioned mix where <code>woody_cover + annual_cover = 1</code></li>
<li>incremental: preserve woody baseline (<code>woody_cover = 1</code>) and add the annual delta scaled by <code>annual_cover</code></li>
</ul>
<p>The current analysis uses the weighted method to represent ground cover in orchards and vineyards.</p>
<p>Outputs include <code>multi_pft_ensemble_output.csv</code>, <code>combined_ensemble_output.csv</code>, and <code>ensemble_output_with_mixed.csv</code> with a synthetic mixed PFT.</p>
</section>
<section id="downscale-aggregate-to-county-and-plot" class="level3">
<h3 class="anchored" data-anchor-id="downscale-aggregate-to-county-and-plot">6. Downscale, Aggregate to County, and Plot</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/040_downscale.R</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/041_aggregate_to_county.R</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/042_downscale_analysis.R</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> scripts/043_county_level_plots.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Builds Random Forest models to predict carbon pools for all fields; aggregates to county-level; summarizes variable importance; and produces maps:</p>
<ul>
<li>Train models on SIPNET ensemble runs at design points</li>
<li>Use environmental covariates to downscale predictions to all fields</li>
<li>Aggregate to county-level estimates</li>
<li>Output maps and statistics of carbon density and totals</li>
</ul>
<p><strong>Inputs:</strong> - <code>model_outdir/ensemble_output.csv</code>: SIPNET outputs extracted in step 4 - <code>data/site_covariates.csv</code>: Environmental covariates</p>
<p><strong>Outputs from <code>040_downscale.R</code>:</strong> - <code>model_outdir/downscaled_preds.csv</code>: Per-site, per-ensemble predictions with totals and densities - <code>model_outdir/downscaled_preds_metadata.json</code>: Metadata for predictions - <code>model_outdir/training_sites.csv</code>: Training site list per PFT and pool - <code>cache/models/*_models.rds</code>: Saved RF models per spec - <code>cache/training_data/*_training.csv</code>: Training covariate matrices per spec - <code>model_outdir/downscaled_deltas.csv</code>: Optional start→end deltas when available</p>
<p><strong>Outputs from <code>041_aggregate_to_county.R</code>:</strong> - <code>model_outdir/county_summaries.csv</code>: County statistics (means/SDs across ensembles for stocks and densities)</p>
<p><strong>Outputs from <code>042_downscale_analysis.R</code> (saved in <code>figures/</code>):</strong> - <code>&lt;pft&gt;_&lt;pool&gt;_importance_partial_plots.png</code>: Variable importance with partial plots for top predictors - <code>&lt;pft&gt;_&lt;pool&gt;_ALE_predictor&lt;i&gt;.svg</code> and <code>&lt;pft&gt;_&lt;pool&gt;_ICE_predictor&lt;i&gt;.svg</code>: ALE and ICE plots</p>
<p><strong>Outputs from <code>043_county_level_plots.R</code> (saved in <code>figures/</code>):</strong> - <code>county_&lt;pft&gt;_&lt;pool&gt;_carbon_stock.webp</code> and <code>county_&lt;pft&gt;_&lt;pool&gt;_carbon_density.webp</code>: County-level maps - <code>county_diff_woody_plus_annual_minus_woody_&lt;pool&gt;_carbon_{density,stock}.webp</code>: Scenario difference maps - <code>county_delta_&lt;pft&gt;_&lt;pool&gt;_carbon_{density,stock}.webp</code>: Start→end delta maps when available</p>
</section>
</section>
<section id="running-on-bu-cluster" class="level2">
<h2 class="anchored" data-anchor-id="running-on-bu-cluster">Running on BU Cluster</h2>
<p>Interactive session (example):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qrsh</span> <span class="at">-l</span> h_rt=3:00:00 <span class="at">-pe</span> omp 16 <span class="at">-l</span> buyin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Submit a batch job (example using downscaling step):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qsub</span> <span class="dt">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-l</span> h_rt=4:00:00 <span class="dt">\</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-pe</span> omp 8 <span class="dt">\</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-o</span> logs/040.out <span class="dt">\</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> logs/040.err <span class="dt">\</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-b</span> y Rscript scripts/040_downscale.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="documentation-site-quarto" class="level2">
<h2 class="anchored" data-anchor-id="documentation-site-quarto">Documentation Site (Quarto)</h2>
<ul>
<li>Preview: <code>quarto preview</code></li>
<li>Build: <code>quarto render</code></li>
<li>Publish to GitHub Pages: <code>quarto publish gh-pages</code> (publishes <code>_site/</code>)</li>
</ul>
<p>Notes: - Quarto config is in <code>_quarto.yml</code> and the home page is <code>index.qmd</code> (includes <code>README.md</code>). - Uses <code>freeze: auto</code> to cache outputs; rebuild where data paths exist (see <code>000-config.R</code>).</p>
</section>
<section id="technical-reference" class="level2">
<h2 class="anchored" data-anchor-id="technical-reference">Technical Reference</h2>
<section id="ensemble-structure" class="level3">
<h3 class="anchored" data-anchor-id="ensemble-structure">Ensemble Structure</h3>
<p>Each ensemble member represents a plausible realization given parameter and meteorological uncertainty. This ensemble structure is maintained throughout the workflow to properly propagate uncertainty. For example, downscaling is done for each ensemble member separately, and then the results are aggregated to county-level statistics.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>