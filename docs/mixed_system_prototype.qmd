---
title: "Mixed-System Prototype (Two-PFT Aggregation)"
#quarto-cache: true
format:
  html:
    self-contained: true
execute:
#  cache: true
  echo: false
  warning: false
  message: false
---

This document prototypes a workflow for modeling croplands with multiple crops ("mixed cropping systems"). 

## Challenge

A number of Healthy Soils Practices (HSPs, <TK citation>) involve mixed cropping systems. These include hedgerows, orchard ground cover, windbreaks, riparian buffers, intercropping, and cover crop mixtures (Appendix).

It is important to be able to represent scenarios that contain multiple crops at the same time. 
The challenge is that SIPNET simulates only one Plant Functional Type (PFT) - a standard approach used in many land surface, biogeochemistry, and crop models.

## Approach

### Context

Here we only consider cropping systems where two PFTs are present at the same time.

This includes:

- Cover crop mixtures
- Agroforestry
- Woody Buffers
- Orchards with ground cover 

This does not include:

- Cases where where the different crops separated in time:
  - cover crops
  - multiple crops in sequence
  - annual to perennial crop (or vice-versa) transitions. 
- Plant mixtures that can be represented as a single PFT.

### Algorithm

The general approach for combining runs at each site is to:

1.  Run SIPNET separately for each PFT
2.  Combine the model outputs from the individual PFT.


#### Initial Conditions Generation (IC)

1. Run as normal, but for each PFT at each site.
2. Settings File:
   - For each mixed site, create separate configuration entries for each PFT; append `-PFT` to the site ID.
3. For herbaceous crops: 
   - annual herbaceous: assume start with bare ground (zero biomass).
   - perennial herbaceous (MVP): start as bare ground run; consider methods for estimating initial biomass in later iterations. 
4. For woody crops:
   - Use existing approach to generate initial conditions.
5. Run PEcAn SIPNET pipeline to generate initial conditions for each PFT.
6. Soil Conditions:
    - Assign whole-site values for soil organic carbon (SOC), soil water content, and other soil parameters to each PFT.

#### Model Execution

- Execute PEcAn SIPNET model independently for each PFT and site combination.
- Following PEcAn convention, netCDFs will be in `out/ENS-{ensemble_number}-{site_id}-{pft}`.

#### Post-processing Outputs

- Combine outputs: For each mixed site, combine model outputs using the appropriate approach (Discrete / Weighted or Overlap / Incremental). Combination methods are described in the following section.
- Standardize Results: Outputs are formatted into ensemble files (`combined_ensemble_output.csv`) for downstream analysis and visualization.

#### Downscaling and Analysis

1. **Downscaling:**
  - [open question] Build downscaling model from merged outputs, or downscale each PFT separately and then merge downscaled outputs?
  - Apply machine learning models trained separately for each PFT to downscale outputs.
  - Combine downscaled outputs using fractional cover to produce integrated maps and analyses.


### Mixture Methods

#### Two Cases for Mixed Cropping Systems: Discrete and Overlap

In a mixed cropping system, we define $f_{woody}$ and $f_{annual}$ as the percent contribution of a crop or plant functional type to ecosystem dynamics. This contribution is not "canopy cover" since that changes over time. Think of this as "percent of a monoculture". <!-- perhaps we should call this something other than 'cover', like "percent of a monoculture" -->This method will build on SIPNET's single PFT design - the outputs from two separate single PFT runs simulate will be combined. 

The two methods of mixing described below are "Discrete" and "Overlap".

We define $X$ as the carbon stock. For a finite time interval $\Delta t$ starting at $t_0$ (the start of the simulation) the change is $\Delta X_{\Delta t} = X(t_0 + \Delta t) - X(t_0)$.

#### Scenario 1: Discrete (Weighted)

For the Discrete case, we use a _Weighted Average_ approach.

The Discrete case refers to mixed systems where the two different crops do not overlap. This covers two key scenarios: 1) each PFT occupies a distinct zones such as an annual crop with woody hedgerows or 2) a mixture of annuals. In this annual mixture case, the approach assumes that the plants do not overlap - even though this is not the case, it is a reasonable simplification. In the **discrete case**, we define $f_{woody} + f_{annual} = 1$ and the field scale ecosystem dynamics are approximated by weighting SIPNET outputs by the fractional area of each crop type within a field:
$$
X_{\textrm{site}} = f_{\textrm{woody}}\cdot X_{\textrm{woody}} + f_{\textrm{annual}}\cdot X_{\textrm{annual}}
\label{eq:discrete}\tag{1}
$$

#### Scenario 2: **Overlap** 

For the Overlap case, we use an _Incremental_ approach.

The Overlap case will apply when a ground cover is added to an orchard. When a ground cover is added to an orchard, it is not expected to reduce the contribution of the orchard species to ecosystem dynamics to a fraction. Rather, we keep $f_\textrm{woody} = 1$ and set $f_\textrm{annual} <1$ to represent the contribution of the ground cover to the system. Reducing $f_\textrm{woody}$ would be equivalent to removing standing orchard biomass at the moment the ground cover is planted. In this case, the ground cover effect is added proportional to its cover and biomass relative to a monoculture in full sun.

We start by assuming that all orchards, both with and without ground cover, represent the same biomass as a monoculture, and set $f_{woody} = 1$. When ground cover is added, it is treated as addition to the ecosystem, and the value of $f_{annual}<1$ reflects the fraction of a monoculture that it represents - accounting for both percent of area that it covers as well as the fact that competition for light reduces its effect on ecosystem functioning.

$$
X_\textrm{site} = X_\textrm{woody} + f_\textrm{annual}\cdot\Delta X_\textrm{annual}
\label{eq:overlap}\tag{2}
$$


#### Summary Table

| Example System | Scenario | Method | Eqn. |
| :-------------- | :-------- | :----- | :------: |
| Annual Crops + Woody Hedgerow | Discrete | Weighted Average | \eqref{eq:discrete} |
| Orchard + Ground Cover | Overlap | Incremental | \eqref{eq:overlap} |


## Demonstration

Here we illustrate this approach using the orchard + ground cover and annual crop + hedgerows scenarios.

We consider a set of mixtures that will be used in the examples and figures below; the percent columns indicate the fractional contribution of each Plant Functional Type (PFT) used for simple area-weighted aggregation.

| Scenario                                      | Woody (%) | Annual (%) | Method   |
| :-------------------------------------------- | --------: | ---------: | :------- |
| 100% woody perennial (orchard / monoculture)  |       100 |          0 | discrete |
| 100% annual herbaceous (monoculture)          |        0 |         100 | discrete |
| Orchard + 25% herbaceous ground cover         |       100 |         25 | overlap  |
| Orchard + 50% herbaceous ground cover         |       100 |         50 | overlap  |
| Annual crop + 25% woody hedgerows             |        25 |         75 | discrete |
| Annual crop + 50% woody hedgerows             |        50 |         50 | discrete |

These scenarios can be referenced by their descriptive names (e.g., "Orchard + 25% cover") in the downstream code and figures.

## Illustrative Examples

### Run Configuration

These runs use SIPNET grass and temperate deciduous PFT parameterizations to represent annual and perennial woody crops, respectively. 

These were run at 10 from 2016 through 2024 with an ensemble size of 20.

```{r setup}
library(tidyverse)
library(lubridate)
library(here)
library(stringr)  # for label wrapping
library(grid)     # grid::unit() for panel spacing

source(here::here("000-config.R"))
if (!dir.exists(model_outdir)) {
    model_outdir <- "data"
}

# helper: replace " + " with newline so labels use two lines
mix_label_fn <- function(x) stringr::str_replace_all(x, " \\+ ", "\n+ ")

# labeller that applies the above to mix_order (fallback to a normal wrap for other strips)
mix_labeller <- labeller(
  mix_order = mix_label_fn,
  .default = label_wrap_gen(width = 12)
)

pal_mix <- c(
  monoculture = "#1b9e77",
  discrete = "#d95f02",
  overlap = "#7570b3"
)

base_theme <- theme_minimal(base_size = 10) +
  theme(
    legend.position = "top",
    strip.text = element_text(size = 9, lineheight = 0.95,
                              margin = margin(2, 2, 2, 2)),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    plot.margin = margin(5, 5, 5, 5),
    plot.title.position = "plot",
    # center title and subtitle
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

wrap_labeller <- labeller(.default = label_wrap_gen(width = 12))
year_scale_dt <- scale_x_datetime(date_breaks = "1 year",
                                  date_labels = "%Y",
                                  expand = expansion(mult = c(0.01, 0.02)))
```

## Mixed-system dataset

The `combined_output` tibble contains the combined outputs for different scenarios (discrete, overlap).

```{r data-prep}
# ---- Mixed-system dataset ----------------------------------------------------
# created in 031_aggregate_sipnet_output.R
combined_output_csv <- here::here(
  file.path(model_outdir, "combined_ensemble_output.csv")
)
combined_output <- readr::read_csv(
  combined_output_csv,
  show_col_types = FALSE
) |>
  # map legacy variable name to short name used in plots/tables
  mutate(variable = recode(variable, "TotSoilCarb" = "SOC")) |>
  mutate(
    # keep mix_description as the canonical value but display explicit labels via mix_order
    # TODO: move recoding to 031_aggregate_sipnet_output.R
    mix_order = factor(
      mix_description,
      levels = c(
        "annual", "annual + 25% woody", "annual + 50% woody",
        "woody", "woody + 25% annual", "woody + 50% annual"
      ),
      labels = c(
        "100% annual", "100% annual + 25% woody", "100% annual + 50% woody",
        "100% woody", "100% woody + 25% annual", "100% woody + 50% annual"
      )
    ),
    mix_type = case_when(
      mix_description %in% c("annual", "woody") ~ "monoculture",
      scenario == "discrete" ~ "discrete",
      scenario == "overlap" ~ "overlap",
      TRUE ~ "other"
    )
  ) |>
  arrange(across(any_of(c("site_id", "mix_description", "scenario",
                          "ensemble_id", "datetime")))) |>
  mutate(line_group = interaction(
    across(all_of(c("ensemble_id", "mix_description", "scenario", "site_id"))),
    drop = TRUE
  ))

vars <- unique(combined_output$variable)
```

```{r select-representative-sites}
agb_site <- combined_output |>
  filter(mix_description == "woody", variable == "AGB") |>
  group_by(site_id) |>
  summarise(agb_mean = mean(value_combined, na.rm = TRUE), .groups = "drop")

if (nrow(agb_site) >= 3) {
  qs_agb <- quantile(
    agb_site$agb_mean,
    probs = c(0.15, 0.50, 0.85), na.rm = TRUE
  )
  analysis_sites <- purrr::map_chr(qs_agb, function(qv) {
    agb_site |>
      mutate(diff = abs(agb_mean - qv)) |>
      slice_min(diff, n = 1, with_ties = FALSE) |>
      pull(site_id)
  }) |> unique()

  if (length(analysis_sites) != 3) {
    PEcAn.logger::logger.error("Representative sites not found for all quantiles")
  }
  site_map <- tibble(
    site_id = analysis_sites,
    agb_class = factor(c("low agb", "med_agb", "high_agb"),
                       levels = c("low agb", "med_agb", "high_agb"))
  )
}

# join and relabel classes for plotting (use human-friendly labels)
output_representative_sites <- site_map |>
  left_join(combined_output, by = "site_id") |>
  mutate(
    agb_class = factor(
      agb_class,
      levels = c("low agb", "med_agb", "high_agb"),
      labels = c("low AGB site", "med AGB site", "high AGB site")
    )
  )
```


### Summary Statistics

```{r summary-table}
summary_stats <- combined_output |>
  group_by(variable, mix_order, mix_type) |>
  summarise(
    mean = mean(value_combined, na.rm = TRUE),
    sd = sd(value_combined, na.rm = TRUE),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    id_cols = c(mix_order, mix_type),
    names_from = variable,
    values_from = c(mean, sd),
    names_glue = "{tolower(variable)}_{.value}"
  )

knitr::kable(summary_stats, 
  digits = 2, 
  col.names = c("Mixture", "Type", "AGB (mean)", "AGB (sd)", "SOC (mean)", "SOC (sd)")
)
```

### Carbon Pool Sizes For Different Mixture Types

What we expect to see here: 

- The discrete mixtures represent weighted averages of the component PFTs (so annual + 25% woody).
- The overlap mixtures will represent the woody perennial, with a small contribution from the annual crop.

```{r carbon-pools}
# Ensemble-level annual medians (per ensemble) for absolute pool sizes
annual_stats_ens <- combined_output |>
  mutate(year = year(datetime)) |>
  group_by(variable, mix_order, mix_type, year, ensemble_id) |>
  summarise(q50 = median(value_combined, na.rm = TRUE), .groups = "drop")

# ensure we have a year column and data
if (nrow(annual_stats_ens) > 0) {
  last_year <- max(annual_stats_ens$year, na.rm = TRUE)

  # end-year ensemble values (absolute magnitudes)
  endyr_ens <- annual_stats_ens |>
    filter(year == last_year)

  if (nrow(endyr_ens) > 0) {
    # Summarize across ensembles to get IQR + median per mix (for error bars)
    summary_pools <- endyr_ens |>
      group_by(variable, mix_order, mix_type) |>
      summarise(
        q25 = quantile(q50, 0.25, na.rm = TRUE),
        q50 = median(q50, na.rm = TRUE),
        q75 = quantile(q50, 0.75, na.rm = TRUE),
        .groups = "drop"
      )

    # Plot: ensemble points (jitter) + IQR + median; facet by variable
    ggplot() +
      geom_jitter(
        data = endyr_ens,
        aes(x = mix_order, y = q50, color = mix_type),
        width = 0.15, alpha = 0.5, size = 1.2
      ) +
      geom_errorbar(
        data = summary_pools,
        aes(x = mix_order, ymin = q25, ymax = q75),
        width = 0.4, color = "black", linewidth = 0.6
      ) +
      geom_point(
        data = summary_pools,
        aes(x = mix_order, y = q50),
        color = "black", size = 2
      ) +
      facet_wrap(~ variable, scales = "free_y", nrow = 1, labeller = mix_labeller) +  # use mix_labeller
      scale_x_discrete(labels = mix_label_fn) +                                       # wrap x labels into two lines
      scale_color_manual(values = pal_mix) +
      labs(
        title = paste0("End-Year Carbon Pool Sizes (", last_year, ")"),
        subtitle = "Points = ensemble members; bars = IQR; black dot = median",
        x = "Mixture",
        y = expression("Carbon Pool Size (" * kg ~ C ~ m^-2 * ")"),
        color = "Type"
      ) +
      base_theme +
      theme(axis.text.x = element_text(angle = 35, hjust = 1))
  } else {
    message("No end-year ensemble data available for carbon pool sizes")
  }
} else {
  message("No ensemble annual stats available to compute carbon pool sizes")
}
```

### Effect Size (Final Year Δ vs Monocultures)

These plots show the change in carbon pool sizes for each mixture compared to the monoculture baselines. Left panels are relative to annual monocultures; right panels are relative to woody monocultures.
```{r effect-size-probabilistic}
# Compute ensemble-level annual medians (per ensemble) so deltas are calculated within each ensemble
annual_stats_ens <- combined_output |>
  group_by(variable, mix_description, mix_order, mix_type, year, ensemble_id) |>
  summarise(
    q50 = median(value_combined, na.rm = TRUE),
    .groups = "drop"
  )

last_year <- max(annual_stats_ens$year, na.rm = TRUE)

# Mixture ensemble results (exclude pure monocultures)
mix_ens <- annual_stats_ens |>
  filter(year == last_year, !(mix_description %in% c("annual", "woody"))) |>
  select(variable, mix_description, mix_order, mix_type, ensemble_id, q50)

# Baseline per ensemble for monocultures (annual & woody)
base_ens <- annual_stats_ens |>
  filter(year == last_year, mix_description %in% c("annual", "woody")) |>
  select(variable, mix_description, mix_order, ensemble_id, baseline = q50)

# Join ensemble-specific baselines to mixtures so deltas are ensemble-specific
delta_ens <- mix_ens |>
  left_join(
    base_ens |> 
      filter(mix_description == "annual") |> 
      select(variable, ensemble_id, annual_baseline = baseline),
    by = c("variable", "ensemble_id")
  ) |>
  left_join(
    base_ens |> 
      filter(mix_description == "woody") |> 
      select(variable, ensemble_id, woody_baseline = baseline),
    by = c("variable", "ensemble_id")
  ) |>
  mutate(
    delta_vs_annual = q50 - annual_baseline,
    delta_vs_woody  = q50 - woody_baseline
  ) |>
  pivot_longer(
    cols = starts_with("delta_vs"),
    names_to = "baseline_ref",
    values_to = "delta"
  ) |>
  mutate(
    baseline_ref = factor(
      baseline_ref,
      levels = c("delta_vs_annual", "delta_vs_woody"),
      labels = c("Δ vs Annual monoculture", "Δ vs Woody monoculture")
    )
  )

summary_delta <- delta_ens |>
  group_by(variable, mix_order, baseline_ref) |>
  summarise(
    q25 = quantile(delta, 0.25, na.rm = TRUE),
    q50 = median(delta, na.rm = TRUE),
    q75 = quantile(delta, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

# Jittered ensemble points + IQR bars + median points
ggplot() +
  geom_hline(yintercept = 0, color = "grey60", linewidth = .4) +
  geom_jitter(
    data = delta_ens,
    aes(x = mix_order, y = delta, color = mix_type),
    width = 0.15, height = 0, alpha = 0.5, size = 1.2
  ) +
  geom_errorbar(
    data = summary_delta,
    aes(x = mix_order, ymin = q25, ymax = q75),
    width = 0.4, color = "black", linewidth = 0.5
  ) +
  geom_point(
    data = summary_delta,
    aes(x = mix_order, y = q50),
    color = "black", size = 0.75
  ) +
  facet_grid(variable ~ baseline_ref, scales = "free_y", labeller = mix_labeller) +
  scale_x_discrete(labels = mix_label_fn) +
  scale_color_manual(values = pal_mix) +
  labs(
    title = paste0("Effect Size in ", last_year),
    x = "Mixture", 
      y = expression(Delta ~ "(Mixture - Baseline) (" * kg ~ C ~ m^-2 * ")"),
    color = "Type"
  ) +
  base_theme +
  theme(
    axis.text.x = element_text(angle = 35, hjust = 1),
    panel.spacing.y = unit(1.5, "lines")  # <-- increase vertical spacing between facet rows
  )
```

---

# <span style="color:grey">Below is Draft Material</span>

--- 

## <span style="color:grey">Nothing to see here</span>

---

## These aren't as interesting.

Except that the lines are wiggly

### Time Series (All Sites)

```{r}
for (v in vars) {
    # create a stable plotting group so ensemble lines stay continuous
    dv <- combined_output |>
        filter(variable == v) |>
        mutate(plot_group = interaction(ensemble_id, mix_description, scenario, site_id, drop = TRUE))

    qv <- dv |>
        group_by(variable, mix_order, datetime) |>
        summarise(
            q25 = quantile(value_combined, .25, na.rm = TRUE),
            q50 = median(value_combined, na.rm = TRUE),
            q75 = quantile(value_combined, .75, na.rm = TRUE),
            .groups = "drop"
        )

    p <- ggplot() +
        geom_line(
            data = dv,
            aes(datetime, value_combined, group = plot_group, color = mix_type),
            alpha = .25, linewidth = .35
        ) +
        geom_ribbon(
            data = qv,
            aes(datetime, ymin = q25, ymax = q75, group = mix_order),
            inherit.aes = FALSE, alpha = 0.25, fill = "black",
            linetype = "dashed"
        ) +
        geom_line(
            data = qv,
            aes(datetime, q50, group = mix_order),
            color = "black", linewidth = .5
        ) +
        facet_wrap(~mix_order, nrow = 2, labeller = mix_labeller, scales = "free_y") +
        year_scale_dt +
        scale_color_manual(values = pal_mix) +
        labs(
            title = paste("Time Series (Median & IQR):", v),
            subtitle = "Lines=ensembles; black=median; ribbon=IQR",
            x = NULL, y = bquote("Carbon Pool Size (" * kg ~ C ~ m^-2 * ")"), 
            color = "Category"
        ) +
        base_theme
    print(p)
}
```

### Time Series (Representative Sites)

Here we focus on representative sites for each mixture.

We selected 3 sites that represent low, medium, and high productivity (AGB) defined as the 15th, 50th, and 85th percentiles of AGB.

```{r}
for (v in vars) {
    dv <- output_representative_sites |>
        filter(variable == v) |>
        # ensure ensemble lines are connected within each (site x mix) panel
        mutate(plot_group = interaction(ensemble_id, mix_description, site_id, drop = TRUE))

    qv <- dv |>
        group_by(variable, agb_class, mix_order, datetime) |>
        summarise(
            q25 = quantile(value_combined, .25, na.rm = TRUE),
            q50 = median(value_combined, na.rm = TRUE),
            q75 = quantile(value_combined, .75, na.rm = TRUE),
            .groups = "drop"
        )

    p <- ggplot() +
        geom_line(
            data = dv,
            aes(datetime, value_combined,
                group = plot_group, color = mix_type
            ),
            alpha = .25, linewidth = .35
        ) +
        geom_ribbon(
            data = qv,
            aes(datetime, ymin = q25, ymax = q75, group = interaction(agb_class, mix_order)),
            inherit.aes = FALSE, alpha = 0.25, fill = "black",
            linetype = "dashed"
        ) +
        geom_line(
            data = qv,
            aes(datetime, q50, group = interaction(agb_class, mix_order)),
            color = "black", linewidth = .6
        ) +
        # Layout: one row per productivity class (low/med/high AGB), one column per mix_order
        facet_grid(agb_class ~ mix_order, labeller = mix_labeller, scales = "free_y") +
        year_scale_dt +
        scale_color_manual(values = pal_mix) +
        labs(
            title = paste("Representative Sites:", v),
            subtitle = "Lines = ensemble members; black = median; ribbon = IQR (by AGB class)",
            x = NULL, y = "Carbon Pool Size (kg C m-2)", color = "Category"
        ) +
        base_theme
    print(p)
}
```


## Appendix

### Survey of Approaches to Simulating Mixed Vegetation with SIPNET

We have considered a few approaches to modeling mixed cropping systems:

1. Fractional coverage approach: Independent PFT runs aggregated by fractional coverage. [TK-Cite]  
2. Composite PFT approach: Define a new parameter set representing the mixture (e.g., DayCent; Parton et al. 1998).  
3. Vegetation demography approach: Cohort/size-structured (ED2; Moorcroft et al. 2001; FATES; Fisher et al. 2015; Koven et al. 2020) with explicit competition.

Limitations:

- Composite obscures marginal effects of adding/removing a component.
- Demography models are computationally heavier.
- Simple fractional weighting must treat legacy pools (SOC) carefully (use Δ rather than raw stocks when appropriate).

### Healthy Soils Practices

| Agronomic Practice | Model Representation | Expected GHG Impact on State GHG Inventory | Expected Adoption (CARB 2022 Scoping Plan) | Priority |
| :---- | :---- | :---- | :---- | :---- |
| Cover Crops | Planting/harvest like commodity; PFT/mixture params. | High | High | High |
| Non-Crop Carbon Amendments (manure/compost) | Add surface C & organic N (low C:N litter analog). | High | High | High |
| N Fertilization | Increase soil inorganic N pools. | High | High | High |
| Transition to Certified Organic | Composite of shifts (fertility, amendments, tillage). | High | High | High |
| No-till / Reduced till | Lower decomposition pulses (freq & magnitude). | High | Medium | High |
| Polycultures / Mixtures | Independent PFT runs; combine by fractional contribution. | Medium | Medium | Medium |
| (Water management placeholder) | Increase soil water content. | High |  |  |
| Annual → Perennial | Change PFT; partial biomass retained. | High | Low | Low |
| Agroforestry / Woody Buffers | Independent woody runs; spatial aggregation. | High | Low | Low |
