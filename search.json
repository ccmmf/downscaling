[
  {
    "objectID": "index.html#overview",
    "href": "index.html#overview",
    "title": "Downscaling",
    "section": "Overview",
    "text": "Overview\nThe downscaling workflow predicts carbon pools (SOC and AGB) for California crop fields and aggregates predictions to the county level. It uses ensemble-based uncertainty propagation via SIPNET model runs and Random Forest downscaling.\nKey components: - Environmental covariate extraction from multiple sources (ERA5, SoilGrids, TWI) - Design point selection using k-means clustering - SIPNET model runs at design points - Random Forest models to downscale from design points to all fields - County-level aggregation of carbon estimates\n\nConcepts\n\nAnchor sites: Fields with ground truth validation data (e.g., Ameriflux sites)\nDesign points: Representative fields selected for SIPNET simulation based on environmental clustering\nDownscaling: Process of extending predictions from design points to all California crop fields."
  },
  {
    "objectID": "index.html#environment-and-setup",
    "href": "index.html#environment-and-setup",
    "title": "Downscaling",
    "section": "Environment and Setup",
    "text": "Environment and Setup\n\nKey Configuration Files\n\n.future.R - Sets up parallel processing\n000-config.R - Configuration file for the workflow (called in each workflow script)"
  },
  {
    "objectID": "index.html#quick-start",
    "href": "index.html#quick-start",
    "title": "Downscaling",
    "section": "Quick start",
    "text": "Quick start\n# Load modules (geo cluster example)\nmodule load R/4.4.0 gdal proj geos sqlite udunits quarto\n\n# Decide where the shared CCMMF area lives (or set in .Renviron)\nexport CCMMF_DATA_DIR=/projectnb/dietzelab/ccmmf      # or $HOME/ccmmf-dev\n\ngit clone https://github.com/ccmmf/downscale.git\ncd downscale\n\n# Restore exact packages for this workflow\nR -e 'if (!requireNamespace(\"renv\", quietly = TRUE)) install.packages(\"renv\"); renv::restore()'\n\n# Run the pipeline [Not implemented]\n# R -e 'targets::tar_make()'"
  },
  {
    "objectID": "index.html#running-the-workflow",
    "href": "index.html#running-the-workflow",
    "title": "Downscaling",
    "section": "Running the Workflow",
    "text": "Running the Workflow\nThe workflow consists of these main scripts:\n# 1. Prepare environmental covariates\nRscript scripts/010_prepare_covariates.R\n\n# 2. Assign anchor sites to fields\nRscript scripts/011_prepare_anchor_sites.R\n\n# 3. Select design points via clustering\nRscript scripts/020_cluster_and_select_design_points.R\n\n# 4. Cluster diagnostics and visualization\nRscript scripts/021_clustering_diagnostics.R\n\n# 5. Extract SIPNET output from model runs\nRscript scripts/030_extract_sipnet_output.R  \n\n# 6. Downscale and aggregate to county level\nRscript scripts/040_downscale_and_aggregate.R\n\n# 7. Downscale analysis and interpretation\nRscript scripts/041_downscale_analysis.R\n\n# 8. Generate results documentation\nquarto render reports/downscaling_results.qmd"
  },
  {
    "objectID": "index.html#advanced-setup-and-use",
    "href": "index.html#advanced-setup-and-use",
    "title": "Downscaling",
    "section": "Advanced Setup and Use",
    "text": "Advanced Setup and Use\n\nInteractive Session on BU Cluster\n# On geo.bu.edu:\nqrsh -l h_rt=3:00:00 -pe omp 16 -l buyin\n\n\nJob Submission\nThis is an example of how a script can be run on an HPC\nqsub \\\n  -l h_rt=1:00:00 \\\n  -pe omp 8 \\\n  -o logs/03.out \\\n  -e logs/03.err \\\n  -b y Rscript downscale/999_workflow_step.R\n\n\nBuilding Documentation Site with Quarto\nPreview\nquarto preview\nBuild\nquarto render\n\nPublish to GitHub Pages (gh-pages)\nThese steps will publish to https://ccmmf.github.io/downscaling.\n# Build site locally (runs R code and embeds results)\nquarto render\n\n# Publish the built _site/ to gh-pages\nquarto publish gh-pages\n\n\n\nAdding Content\n\nAdd any .qmd or .md file\nAdd links in _quarto.yml\n\nunder project.render\nin the appropriate section under website.navbar.left.\n\n\n\nNotes on Quarto Configuration\n\nGlobal HTML Settings:\n\nself-contained: true, embed-resources: true, df-print: paged, toc: true.\n\nExecution:\n\nUses freeze: auto to cache outputs; re-executes only when inputs change.\nSome pages (e.g., reports/downscaling_results.qmd) depend on paths in 000-config.R. Build locally where paths exist.\n\nConfiguration:\n\nQuarto settings are in _quarto.yml (generates standalone HTML).\nDoes not use GitHub Actions due to reliance on large local datasets.\n\nHome Page:\n\nDefined in index.qmd (includes this README.md)."
  },
  {
    "objectID": "reports/downscaling_results.html",
    "href": "reports/downscaling_results.html",
    "title": "Downscaling Results and Analysis",
    "section": "",
    "text": "Here we present results of aggregating from field scale pool sizes  to county-level estimates of county-level carbon stocks and densities for soil carbon stocks to 30cm and aboveground biomass.\nNot validated, for illustrative purposes only.\nFor detailed information about methods and workflow, see the Workflow Documentation.\nEstimates for woody and mixed woody + annual systems are done for all fields in the LandIQ dataset with tree and vinyard crops; annual systems are done for all fields with herbaceous annual crops.\nIn the mixed scenario, ground cover is planted in all orchards. The methods for simulating the addition of ground cover to orchards are described in Mixed System Prototype. Briefly, it combines downscaled model outputs from the woody perennial crop and annual crop PFTs to represent the effect of ground cover on carbon pools."
  },
  {
    "objectID": "reports/downscaling_results.html#county-level-carbon-stocks-and-densities",
    "href": "reports/downscaling_results.html#county-level-carbon-stocks-and-densities",
    "title": "Downscaling Results and Analysis",
    "section": "County-Level Carbon Stocks and Densities",
    "text": "County-Level Carbon Stocks and Densities\nThe following maps illustrate the predicted carbon pools at the county level, for each PFT. We show both total county carbon (Tg) and area‑normalized density (Mg/ha).\n\nSoil Carbon (TotSoilCarb) by PFT\n\nAnnual Crop\n\nStock: \nDensity: \n\n\n\nWoody Perennial Crop (Orchards & Vineyards)\nThis is the scenario where there is no ground cover in orchards and vineyards.\n\nStock: \nDensity: \n\n\n\n\n\nDifference: Woody + Annual minus Woody\nThese maps show the impact of adding 50% annual ground cover in orchards. Positive values indicate an increase relative to woody-only.\n\nDensity (Mg/ha): \nStock (Tg): \n\n\n\nAboveground Biomass (AGB) by PFT\n\nAnnual Crop\n\nStock: \nDensity: \n\n\n\nWoody Perennial Crop\n\nStock: \nDensity: \n\n\n\n\n\nDifference: Woody + Annual minus Woody (AGB)\n\nDensity (Mg/ha): \nStock (Tg): \n\n\n\nTables: County Stocks and Density (by PFT) and PFT Comparison\nThe first table summarizes county-level metrics for each PFT. The second table pivots TotSoilCarb density by PFT to simplify cross-PFT comparisons."
  },
  {
    "objectID": "reports/downscaling_results.html#start-to-end-delta-by-pft",
    "href": "reports/downscaling_results.html#start-to-end-delta-by-pft",
    "title": "Downscaling Results and Analysis",
    "section": "Start-to-End Delta by PFT",
    "text": "Start-to-End Delta by PFT\nThe following maps show county-level changes (start-to-end) in carbon density and stock for each PFT and pool. Positive values indicate an increase over the modeled period.\n\nAnnual Crop\n\nTotSoilCarb: density: , stock: \nAGB: density: , stock: \n\n\n\nWoody Perennial Crop\n\nTotSoilCarb: density: , stock: \nAGB: density: , stock: \n\n\n\nPer-county Mixed-Woody Differences (Tables)\n\n\nWarning in dplyr::inner_join(mix, wood, by = c(\"site_id\", \"ensemble\", \"model_output\", : Detected an unexpected many-to-many relationship between `x` and `y`.\nℹ Row 1 of `x` matches multiple rows in `y`.\nℹ Row 1 of `y` matches multiple rows in `x`.\nℹ If a many-to-many relationship is expected, set `relationship =\n  \"many-to-many\"` to silence this warning.\n\n\n\n\n\n\n\n\n\nPer-county Start-to-End Deltas (Tables)"
  },
  {
    "objectID": "reports/design_points_analysis.html",
    "href": "reports/design_points_analysis.html",
    "title": "Design Points Analysis",
    "section": "",
    "text": "Design points are representative locations selected to capture the range of environmental conditions across California croplands from CADWR (2018). These are the locations where SIPNET is run to produce outputs later used in downscaling to all ~600k crop fields.\nWe used clustering to select design points that represent the range of environmental conditions across California croplands. The following figures illustrate the distribution of these design points, which were clustered based on environmental covariates.\nThe environmental covariates used for clustering are:\n\n\n\nVariable\nDescription\nSource\nUnits\n\n\n\n\ntemp\nMean annual temperature\nERA5\n°C\n\n\nprecip\nMean annual precipitation\nERA5\nmm/year\n\n\nsrad\nSolar radiation\nERA5\nW/m²\n\n\nvapr\nVapor pressure deficit\nERA5\nkPa\n\n\nclay\nClay content\nSoilGrids\n%\n\n\nocd\nOrganic carbon density\nSoilGrids\ng/kg\n\n\ntwi\nTopographic wetness index\nSRTM-derived\n-\n\n\n\n\n\nHere we check the geographic distribution of design points relative to the distribution of all croplands. Grey areas are the fields in the CADWR (2018) land use dataset. Boundaries are Climate Zones from CalAdapt (Lyons, 2025).\nThe design points should be well distributed across California croplands and Climate Zones.\n\n\n\nClustered Design Points\n\n\n\n\n\nThis pairs plot shows the relationships between covariates used for clustering, with colors indicating cluster membership.\nThe clusters should show distinct groupings based on the environmental covariates.\n\n\n\nClustered Pairs Plot\n\n\n\n\n\nThese plots present This the normalized mean values of environmental covariates for each cluster.\nThis summary highlights the characteristics of each cluster based on the environmental covariates used for clustering.\nHere we expect to see clusters with distinct environmental signatures, reflecting the unique multivariate profiles of each cluster.\n\n\n\nCluster Summary"
  },
  {
    "objectID": "reports/variable_importance.html",
    "href": "reports/variable_importance.html",
    "title": "Variable Importance and Effects",
    "section": "",
    "text": "Diagnostics reflect exactly what scripts/040_downscale.R and scripts/042_downscale_analysis.R produce.\n\nVariable importance: per-ensemble importance computed during downscaling (040) and summarized by median and IQR across ensembles (042).\nPartial dependence (PDP): top two predictors (by median importance) using the saved RF model and training data from 040.\nALE (Accumulated Local Effects) and ICE: optional if the iml package is available; computed from the same saved model and training data.\n\nNotes\n\nImportance units depend on the RF backend: %IncMSE or an equivalent importance metric; higher values indicate stronger influence.\nPDP assumes feature independence; may mislead under strong collinearity. ALE is preferred in that case and is centered at 0.\nThe mixed scenario (woody + annual) has no standalone model; therefore VI/PDP/ALE/ICE are not generated for that PFT.\nPDPs are generated from a single saved RF model (first ensemble) for illustration, while importance ranks are aggregated across ensembles."
  },
  {
    "objectID": "reports/variable_importance.html#agb-by-pft",
    "href": "reports/variable_importance.html#agb-by-pft",
    "title": "Variable Importance and Effects",
    "section": "AGB by PFT",
    "text": "AGB by PFT\n\nannual crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors.\n\n\n\nwoody perennial crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors."
  },
  {
    "objectID": "reports/variable_importance.html#totsoilcarb-by-pft",
    "href": "reports/variable_importance.html#totsoilcarb-by-pft",
    "title": "Variable Importance and Effects",
    "section": "TotSoilCarb by PFT",
    "text": "TotSoilCarb by PFT\n\nannual crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors.\n\n\n\nannual crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors.\n\n\n\nwoody perennial crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors.\n\n\n\nwoody perennial crop\n\nLeft: variable importance (median across ensembles) with interquartile ranges.\nMiddle/Right: PDP for the top two predictors."
  },
  {
    "objectID": "reports/variable_importance.html#ale-and-ice-effects",
    "href": "reports/variable_importance.html#ale-and-ice-effects",
    "title": "Variable Importance and Effects",
    "section": "ALE and ICE Effects",
    "text": "ALE and ICE Effects"
  },
  {
    "objectID": "reports/variable_importance.html#agb-ale-and-ice",
    "href": "reports/variable_importance.html#agb-ale-and-ice",
    "title": "Variable Importance and Effects",
    "section": "AGB – ALE and ICE",
    "text": "AGB – ALE and ICE\n\nannual crop\n\nTop predictor 1\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\nTop predictor 2\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\n\nwoody perennial crop\n\nTop predictor 1\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\nTop predictor 2\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories."
  },
  {
    "objectID": "reports/variable_importance.html#totsoilcarb-ale-and-ice",
    "href": "reports/variable_importance.html#totsoilcarb-ale-and-ice",
    "title": "Variable Importance and Effects",
    "section": "TotSoilCarb – ALE and ICE",
    "text": "TotSoilCarb – ALE and ICE\n\nannual crop\n\nTop predictor 1\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\nTop predictor 2\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\n\nwoody perennial crop\n\nTop predictor 1\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories.\n\n\n\nTop predictor 2\n\nALE: centered effect; more robust under collinearity.\nICE: per-observation curves; heterogeneity and interactions appear as diverse or crossing trajectories."
  },
  {
    "objectID": "docs/workflow_documentation.html",
    "href": "docs/workflow_documentation.html",
    "title": "Downscaling Workflow Technical Documentation",
    "section": "",
    "text": "The downscaling workflow predicts carbon pools (Soil Organic Carbon and Aboveground Biomass) for cropland fields in California and then aggregates these predictions to the county scale.\nIt uses an ensemble-based approach to uncertainty propagation and analysis, maintaining ensemble structure to propagate errors through the prediction and aggregation processes.\n\n\n\nSpatial downscaling workflow using machine learning with environmental covariates\n\n\n\n\n\nDesign Points: Fields chosen via stratified random sampling using k-means clustering on environmental data layers across California crop fields.\nCrop Fields: All croplands in the LandIQ dataset.\nAnchor Sites: Sites used as ground truth for calibration and validation, including UC research stations and Ameriflux sites.\n\n\n\n\nTODO Workflows (1 & 3) are in this repository and will be split\nThe workflows are\n\nSite Selection: uses environmental variables (in the future we will add agronomic practice changes) to create clusters and then select representative sites. The design_points.csv are then passed to the ensemble workflow.\nEnsemble Runs: generate ensemble outputs. These are done in the ccmmf/workflows repository.\nDownscaling: uses ensemble outputs to make predictions for each field in CA, then aggregates to county level summaries and produces figures.\n\nOverview:\n# Site Selection\nRscript scripts/009_update_landiq.R --production true\nRscript scripts/010_prepare_covariates.R --production true\nRscript scripts/011_prepare_anchor_sites.R --production true\nRscript scripts/020_cluster_and_select_design_points.R --production true\n# Downscaling and Aggregation\nRscript scripts/030_extract_sipnet_output.R --production true\nRscript scripts/040_downscale.R --production true\nRscript scripts/041_aggregate_to_county.R --production true\nRscript scripts/042_downscale_analysis.R --production true\nRscript scripts/043_county_level_plots.R --production true\n\n\n\n\n\nWorkflow settings are configured in 000-config.R.\nThe configuration script reads the CCMMF directory from the environment variable CCMMF_DIR (set in .Renviron), and uses it to define paths for inputs and outputs.\nThe CCMMF_DIR variable, however, is defined in .Renviron so that it can: - Be used to locate and override R library (RENV_PATHS_LIBRARY) and cache (RENV_PATHS_CACHE) paths outside the home directory. - Be easily overridden via a shell export (export CCMMF_DIR=…) without modifying workflow scripts.\n\n\nTo set up this workflow to run on your system, follow the following steps.\nClone Repository\ngit clone git@github.com:ccmmf/downscaling\n\nCCMMF_DIR should point to the shared CCMMF directory. This is the location where data, inputs, and outputs will be stored, as well as the location of the renv cache and library\nRENV_PATHS_CACHE and RENV_PATHS_LIBRARY store the renv cache and library in the CCMMF directory. These are in a subdirectory of the CCMMF directory in order to make them available across all users (and because on some computers, they exceed allocated space in the home directory).\nR_LIBS_USER must point to the platform and R version specific subdirectory inside RENV_PATHS_LIBRARY.\nExample: /projectnb/dietzelab/ccmmf/renv-library/linux-almalinux-8.10/R-4.4/x86_64-pc-linux-gnu\n.Rprofile\n\nsets repositories from which R packages are installed\nruns renv/activate.R\n\n000-config.R\n\nParses a --production flag via argparse to toggle development vs production mode. In non-interactive runs, default is development (--production FALSE); interactive sessions override to production. Example: Rscript scripts/040_downscale.R --production true.\nSets directories for inputs and outputs used by the pipelines.\nSets parallelization via future::plan(multicore, workers = availableCores() - 1).\nControls variables to extract via outputs_to_extract default: c(\"TotSoilCarb\", \"AGB\").\nAuto-sources all helper functions in R/ and runs unit tests under tests/testthat at startup.\n\n\n\n\n\n\n\nRscript scripts/009_update_landiq.R\nRscript scripts/010_prepare_covariates.R\nRscript scripts/011_prepare_anchor_sites.R\nThese scripts prepare data for clustering and downscaling:\n\nConverts LandIQ-derived shapefiles to a geopackage with geospatial information and a CSV with other attributes\nExtracts environmental covariates (clay, organic carbon, topographic wetness, temperature, precipitation, solar radiation, vapor pressure)\nGroups fields into Cal-Adapt climate regions\nAssigns anchor sites to fields\n\nInputs:\n\nLandIQ Crop Map: data_raw/i15_Crop_Mapping_2016_SHP/i15_Crop_Mapping_2016.shp\nSoilgrids: clay_0-5cm_mean.tif and ocd_0-5cm_mean.tif Consider aggregating 0-5,5-15,15-30 into a single 0-30 cm layer\nTWI: TWI/TWI_resample.tiff\nERA5 Met Data: Files in GridMET/ folder named ERA5_met_<YYYY>.tiff\nAnchor Sites: data_raw/anchor_sites.csv\n\nOutputs:\n\nca_fields.gpkg: Spatial information from LandIQ\nca_field_attributes.csv: Site attributes including crop type\nsite_covariates.csv: Environmental covariates for each field\nanchor_sites_ids.csv: Anchor site information\n\nEnvironmental Covariates\n\n\n\nVariable\nDescription\nSource\nUnits\n\n\n\n\ntemp\nMean annual temperature\nERA5\n°C\n\n\nprecip\nMean annual precipitation\nERA5\nmm/year\n\n\nsrad\nSolar radiation\nERA5\nW/m²\n\n\nvapr\nVapor pressure deficit\nERA5\nkPa\n\n\nclay\nClay content\nSoilGrids\n%\n\n\nocd\nOrganic carbon density\nSoilGrids\ng/kg\n\n\ntwi\nTopographic wetness index\nSRTM-derived\n-\n\n\n\n\n\n\nRscript scripts/020_cluster_and_select_design_points.R\nRscript scripts/021_clustering_diagnostics.R\nUses k-means clustering to select representative fields plus anchor sites:\n\nSubsample LandIQ fields and include anchor sites for clustering\nSelect cluster number based on the Elbow Method\nCluster fields using k-means based on environmental covariates\nSelect design points from clusters for SIPNET simulation\n\nInputs: - data/site_covariates.csv - data/anchor_sites_ids.csv\nOutput: - data/design_points.csv\n\n\n\nA separate workflow prepares inputs and runs SIPNET simulations for the design points.\nInputs: - design_points.csv - Initial conditions (from modeling workflow)\nOutputs: - out/ENS-<ensemble_number>-<site_id>/YYYY.nc: NetCDF files containing SIPNET outputs, in PEcAn standard model output format. - out/ENS-<ensemble_number>-<site_id>/YYYY.nc.var: List of variables included in SIPNET output (see table below)\nAvailable Variables\nEach output file named YYYY.nc has an associated file named YYYY.nc.var. This file contains a list of variables included in the output. SIPNET outputs have been converted to PEcAn standard units and stored in PEcAn standard NetCDF files. PEcAn standard units are SI, following the Climate Forecasting standards:\n\nMass pools: kg / m2\n\nTotSoilCarb: Total Soil Carbon\nAbvGrndWood: Above ground woody biomass\n\nMass fluxes: kg / m2 / s-1\n\nGPP: Gross Primary Productivity\nNPP: Net Primary Productivity\n\nEnergy fluxes: W / m2\nOther:\n\nLAI: m2 / m2\n\n\n\n\n\nVariable\nDescription\n\n\n\n\nGPP\nGross Primary Productivity\n\n\nNPP\nNet Primary Productivity\n\n\nTotalResp\nTotal Respiration\n\n\nAutoResp\nAutotrophic Respiration\n\n\nHeteroResp\nHeterotrophic Respiration\n\n\nSoilResp\nSoil Respiration\n\n\nNEE\nNet Ecosystem Exchange\n\n\nAbvGrndWood\nAbove ground woody biomass\n\n\nleaf_carbon_content\nLeaf Carbon Content\n\n\nTotLivBiom\nTotal living biomass\n\n\nTotSoilCarb\nTotal Soil Carbon\n\n\nQle\nLatent heat\n\n\nTransp\nTotal transpiration\n\n\nSoilMoist\nAverage Layer Soil Moisture\n\n\nSoilMoistFrac\nAverage Layer Fraction of Saturation\n\n\nSWE\nSnow Water Equivalent\n\n\nlitter_carbon_content\nLitter Carbon Content\n\n\nlitter_mass_content_of_water\nAverage layer litter moisture\n\n\nLAI\nLeaf Area Index\n\n\nfine_root_carbon_content\nFine Root Carbon Content\n\n\ncoarse_root_carbon_content\nCoarse Root Carbon Content\n\n\nGWBI\nGross Woody Biomass Increment\n\n\nAGB\nTotal aboveground biomass\n\n\ntime_bounds\nhistory time interval endpoints\n\n\n\n\n\n\nRscript scripts/030_extract_sipnet_output.R\nExtracts and formats SIPNET outputs for downscaling:\n\nExtract output variables (AGB, TotSoilCarb) from SIPNET simulations (configurable via outputs_to_extract).\nAggregate site-level ensemble outputs into a long EFI-style format: datetime, site_id, lat, lon, pft, parameter, variable, prediction.\n\nInputs: - out/ENS-<ensemble_number>-<site_id>/YYYY.nc\nOutputs: - out/ensemble_output.csv: Long format data for selected variables\n\n\n\nRscript scripts/031_aggregate_sipnet_output.R\nSimulates mixed-cropping scenarios by combining outputs across two PFTs using the combine_mixed_crops() function. This is described in more detail in Mixed System Prototype.\nThere are two methods for combining outputs: - weighted: area-partitioned mix where woody_cover + annual_cover = 1 - incremental: preserve woody baseline (woody_cover = 1) and add the annual delta scaled by annual_cover.\nThe current analysis uses the weighted method to represent ground cover in orchards and vineyards.\nOutputs include multi_pft_ensemble_output.csv, combined_ensemble_output.csv, and ensemble_output_with_mixed.csv with a synthetic mixed PFT.\n\n\n\nRscript scripts/040_downscale.R --production true\nRscript scripts/041_aggregate_to_county.R --production true\nRscript scripts/042_downscale_analysis.R --production true\nRscript scripts/043_county_level_plots.R --production true\nBuilds Random Forest models to predict carbon pools for all fields; aggregates to county-level; summarizes variable importance; and produces maps:\n\nTrain models on SIPNET ensemble runs at design points\nUse environmental covariates to downscale predictions to all fields\nAggregate to county-level estimates\nOutput maps and statistics of carbon density and stocls.\n\nInputs: - out/ensemble_output.csv: SIPNET outputs - data/site_covariates.csv: Environmental covariates\nOutputs from 040_downscale.R: - out/downscaled_preds.csv: Per-field predictions with ensemble, area, and county - out/downscaled_preds_metadata.json: Metadata documenting ensembles, PFTs, variables, and date range - out/training_sites.csv: Training site IDs per PFT × pool - out/vi_<pft>_<pool>_by_ensemble.csv: Variable importance per ensemble - out/downscaled_deltas.csv: Start –> end deltas used for delta maps\nOutputs from 041_aggregate_to_county.R: - out/county_summaries.csv: County statistics (means/SDs across ensembles for stocks and densities)\nOutputs from 043_county_level_plots.R (saved in figures/): - County-level maps of carbon stock and density by PFT and pool. - Difference maps (mixed − woody) and delta maps (start→end).\n\n\n\n\nEnsemble Structure\nEach ensemble member represents a plausible realization given parameter and meteorological uncertainty. This ensemble structure is maintained throughout the workflow to properly propagate uncertainty. For example, downscaling is done for each ensemble member separately, and then the results are aggregated to county-level statistics.\nImplementation notes:\n\nEFI-standard column parameter (ensemble ID) is renamed to ensemble in some steps for clarity.\nPool variables are in kg/m² and are converted to Mg/ha for densities via PEcAn.utils::ud_convert(); field-level stocks are computed as density × area."
  },
  {
    "objectID": "docs/references.html",
    "href": "docs/references.html",
    "title": "Downscaling",
    "section": "",
    "text": "References\nEFI Standards\nDietze, Michael C., R. Quinn Thomas, Jody Peters, Carl Boettiger, Gerbrand Koren, Alexey N. Shiklomanov, and Jaime Ashander. 2023. “A Community Convention for Ecological Forecasting: Output Files and Metadata Version 1.0.” Ecosphere 14 (11): e4686. https://doi.org/10.1002/ecs2.4686.\nCADWR LandIQ Crop Map\nCalifornia Department of Water Resources. (2018). Statewide Crop Mapping—California Natural Resources Agency Open Data. Retrieved “Oct 14, 2024” from https://data.cnra.ca.gov/dataset/statewide-crop-mapping.\nCalAdapt\nLyons, Andrew and R Development Core Team. 2025. “Caladaptr: Tools for the Cal-Adapt API in R.” Manual. https://ucanr-igis.github.io/caladaptr.\nSoilGrids250m\nHengl, T. et al. 2017. “SoilGrids250m: Global Gridded Soil Information Based on Machine Learning.” PLoS ONE 12(2): e0169748. https://doi.org/10.1371/journal.pone.0169748\nERA5 Climate Data\nHersbach, H. et al. 2020. “The ERA5 Global Reanalysis.” Quarterly Journal of the Royal Meteorological Society 146: 1999–2049. https://doi.org/10.1002/qj.3803\nCalAdapt Climate Zones CalAdapt. 2024. “Climate Zones.” Accessed October 14, 2024. https://cal-adapt.org/tools/climate-zones/.\nSIPNET\nBraswell, Bobby H., William J. Sacks, Ernst Linder, and David S. Schimel. 2005. “Estimating Diurnal to Annual Ecosystem Parameters by Synthesis of a Carbon Flux Model with Eddy Covariance Net Ecosystem Exchange Observations.” Global Change Biology 11 (2): 335–55. https://doi.org/10.1111/j.1365-2486.2005.00897.x.\nSacks, William J., David S. Schimel, Russell K. Monson, and Bobby H. Braswell. 2006. “Model‐data Synthesis of Diurnal and Seasonal CO2 Fluxes at Niwot Ridge, Colorado.” Global Change Biology 12 (2): 240–59. https://doi.org/10.1111/j.1365-2486.2005.01059.x.\nRandom Forest\nLiaw, Andy, and Matthew Wiener. 2002. “Classification and Regression by randomForest.” R News 2 (3): 18–22. https://CRAN.R-project.org/doc/Rnews/."
  },
  {
    "objectID": "docs/mixed_system_prototype.html",
    "href": "docs/mixed_system_prototype.html",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "",
    "text": "This document prototypes a workflow for modeling croplands with multiple crops (“mixed cropping systems”)."
  },
  {
    "objectID": "docs/mixed_system_prototype.html#challenge",
    "href": "docs/mixed_system_prototype.html#challenge",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Challenge",
    "text": "Challenge\nCARB identifies multiple practices from the Healthy Soils Program (https://www.cdfa.ca.gov/oars/healthysoils/) that rely on mixed cropping systems—such as hedgerows, orchard ground cover, windbreaks, riparian buffers, intercropping, and cover-crop mixtures (CARB, 2022 and Appendix Table 3).\nIt is important to be able to represent scenarios that contain multiple crops at the same time. The challenge is that SIPNET simulates only one Plant Functional Type (PFT) - a standard approach used in many land surface, biogeochemistry, and crop models."
  },
  {
    "objectID": "docs/mixed_system_prototype.html#approach",
    "href": "docs/mixed_system_prototype.html#approach",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Approach",
    "text": "Approach\n\nContext\nHere we consider methods of simulating cropping systems where two ecophysiologically distinct PFTs are present at the same time. These include woody buffers and orchards with ground cover. Here, ecophysiologically distinct means that the two PFTs have different growth forms (woody vs herbaceous) and/or phenology (perennial vs annual).\nWe do not consider mixtures of plant species that are similar enough to represent as a single PFT, including cover crop mixtures and agroforestry. We note that the approach described below could be applied to these practices, and this will be considered if the additional complexity can be justified by potential reduction in uncertainty.\nWe also do not consider practices in which different crops are planted in sequence. These include crop rotations, cover crops, and land use change. These scenarios can be represented as sequential model runs that change PFTs while maintaining a continuously evolving system state.\n\n\nAlgorithm\nThe general approach for combining multiple PFTs into an aggregate estimate of carbon pool size (and later, GHG fluxes) is to:\n\nRun SIPNET separately for each PFT.\nCombine the model outputs from the individual PFT.\n\nTechnical details of these steps are described in more detail below.\n\nInitial Conditions Generation (IC)\n\nRun once for each PFT at each site.\nMeteorology and soil initial conditions:\n\nUse the same meteorological driver data (ERA5 ensemble).\nUse the same soil texture and soil organic carbon.\n\nSettings File:\n\nFor each mixed site, create separate a separate configuration file for each PFT; append -PFT to the site ID.\n\nFor herbaceous crops:\n\nAnnual herbaceous: assume start with bare ground (zero biomass).\nPerennial herbaceous: start as bare ground run; consider methods for estimating initial biomass in later iterations.\n\nFor woody crops:\n\nGenerate initial conditions.\n\n\n\n\nModel Execution\n\nExecute PEcAn SIPNET model independently for each PFT and site combination.\n\nUse ensemble methods to propagate uncertainty and variance in model parameters, meteorological drivers and initial conditions.\n\nFollowing PEcAn convention, netCDFs will be in out/ENS-{ensemble_number}-{site_id}-{pft}.\n\n\n\nPost-processing Outputs\n\nCombine outputs: For each mixed site, combine model outputs using one of the approaches defined below.\nStandardize Results: Outputs are formatted into ensemble files (combined_ensemble_output.csv) for downstream analysis and visualization.\n\n\n\nDownscaling and Analysis\n\nDownscaling:\n\nApply machine learning models trained separately for each PFT to downscale outputs.\nCombine downscaled outputs using one of the methods described below.\n\nAnalysis:\n\nCalibrate using site level mixtures.\nValidate against downscaled outputs.\n\n\n\n\n\nMixture Methods\n\nTwo Cases for Mixed Cropping Systems: Discrete and Overlap\nIn a mixed cropping system, we define \\(f_{woody}\\) and \\(f_{annual}\\) as the percent contribution of a crop or plant functional type to ecosystem dynamics. This contribution is not “canopy cover” since that changes over time. Think of this as “percent of a monoculture”. This method will build on SIPNET’s single PFT design - the outputs from two separate single PFT runs simulate will be combined.\n\n\nTable 1: Methods for combining two plant functional types (PFTs) in mixed cropping systems.\n\n\n\n\n\n\n\n\nExample System\nScenario\nMethod\nEqn.\n\n\n\n\nAnnual Crops + Woody Hedgerow\nDiscrete\nWeighted Average\n1\n\n\nOrchard + Ground Cover\nOverlap\nIncremental\n2\n\n\n\n\nNotation\nWe define the following values:\n\n\\(X\\) is the carbon stock (AGB or SOC).\nFor a finite time interval \\(\\Delta t\\) starting at \\(t_0\\) (the start of the simulation) the change is \\(\\Delta X_{\\Delta t} = X(t_0 + \\Delta t) - X(t_0)\\).\n\\(f_{woody}\\) and \\(f_{annual}\\) are the fractional contributions of each PFT to ecosystem dynamics. In the case of the discrete method, these represent cover and sum to 1. In the overlap case, \\(f_{woody} = 1\\) and \\(f_{annual} < 1\\).\n\n\n\nScenario 1: Discrete (Weighted)\nFor the Discrete case, we use a Weighted Average approach (Equation 1).\nThe Discrete case refers to mixed systems where the two different crops do not overlap. This covers two key scenarios: 1) each PFT occupies a distinct zones such as an annual crop with woody hedgerows or 2) a mixture of annuals. In this annual mixture case, the approach assumes that the plants do not overlap - even though this is not the case, it is a reasonable simplification. In the discrete case, the field scale ecosystem dynamics are approximated by weighting SIPNET outputs by the fractional area of each crop type within a field: \\[\nX_{\\textrm{site}} = f_{\\textrm{woody}}\\cdot X_{\\textrm{woody}} + f_{\\textrm{annual}}\\cdot X_{\\textrm{annual}}\n\\tag{1}\\]\n\n\nScenario 2: Overlap\nFor the Overlap case, we use an Incremental approach (Equation 2).\nThis scenario applies when a ground cover is added to an existing orchard orchard. We set \\(f_\\textrm{woody} = 1\\), reflecting the assumption that the addition of ground cover does not reduce the contribution of the woody species to ecosystem dynamics. Lowering this fraction below 1 at the moment of planting would represent an unrealistic scenario in which adding ground cover also reduced standing orchard biomass and associated impact of the woody species on ecosystem function. When woody biomass removal occurs, it is represented as a distinct harvest event.\nThe contribution of the ground cover is added incrementally to the system. The parameter \\(f_\\text{annual}\\) represents the “ecosystem impact factor” - the fraction of a monoculture’s influence on ecosystem functioning that the ground cover contributes to this mixed system.\nThis factor is always less than 1 (\\(f_\\textrm{annual} < 1\\)), as it accounts for both the percent of area covered by the ground cover and the reduction in its ecosystem impact due to competition for light and other resources.\nThus, when ground cover is added, it is treated as an addition to the ecosystem, and the orchard (woody monoculture) is assumed to remain unchanged.\n\\[\nX_\\textrm{site} = X_\\textrm{woody} + f_\\textrm{annual}\\cdot\\Delta X_\\textrm{annual}\n\\tag{2}\\]"
  },
  {
    "objectID": "docs/mixed_system_prototype.html#demonstration",
    "href": "docs/mixed_system_prototype.html#demonstration",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Demonstration",
    "text": "Demonstration\nHere we illustrate this approach using the orchard + ground cover and annual crop + hedgerows scenarios.\nWe consider a set of mixtures used in the examples and figures below (Table 2); the percent columns indicate the fractional contribution of each Plant Functional Type (PFT).\n\n\nTable 2: Set of mixture scenarios used for demonstration.\n\n\n\n\n\n\n\n\nScenario\nWoody (%)\nAnnual (%)\nMethod\n\n\n\n\n100% woody perennial\n100\n0\nmonoculture\n\n\n100% annual herbaceous\n0\n100\nmonoculture\n\n\nOrchard + 25% herbaceous ground cover\n100\n25\noverlap\n\n\nOrchard + 50% herbaceous ground cover\n100\n50\noverlap\n\n\nAnnual crop + 25% woody hedgerows\n25\n75\ndiscrete\n\n\nAnnual crop + 50% woody hedgerows\n50\n50\ndiscrete"
  },
  {
    "objectID": "docs/mixed_system_prototype.html#illustrative-examples",
    "href": "docs/mixed_system_prototype.html#illustrative-examples",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Illustrative Examples",
    "text": "Illustrative Examples\n\nRun Configuration\nThese runs use SIPNET grass and temperate deciduous PFT parameterizations to represent annual and perennial woody crops, respectively.\nThese simulations were run from 2016 through 2024 across 10 sites, with an ensemble size of 20."
  },
  {
    "objectID": "docs/mixed_system_prototype.html#mixed-system-dataset",
    "href": "docs/mixed_system_prototype.html#mixed-system-dataset",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Mixed-system dataset",
    "text": "Mixed-system dataset\nThe combined_ensemble_output.csv file contains the combined outputs for different scenarios (discrete, overlap).\n\n\n\nSelecting Representative Sites\nNext we select representative sites based on their productivity. We use AGB in the 100% woody scenario as an indicator of productivity. We select sites that are near the 15th, 50th, and 85th percentiles of AGB and categorize them as low, medium, and high productivity.\n\n\n\n\nSummary Statistics\n\n\n\n\n\nSummary statistics (mean and standard deviation) for carbon pools by mixture type.\n\n\nMixture\nType\nAGB\nSOC\n\n\n\n\n100% woody\nmonoculture\n4.7 (2.7)\n1.8 (0.6)\n\n\n100% annual\nmonoculture\n0.3 (0.5)\n1.3 (0.7)\n\n\n100% woody + 25% annual\noverlap\n4.8 (2.8)\n1.8 (0.6)\n\n\n100% woody + 50% annual\noverlap\n4.9 (2.8)\n1.8 (0.6)\n\n\n75% annual + 25% woody\ndiscrete\n1.4 (0.9)\n1.4 (0.6)\n\n\n50% annual + 50% woody\ndiscrete\n2.5 (1.4)\n1.6 (0.5)\n\n\n\n\n\n\n\nCarbon Pool Sizes For Different Mixture Types\nWhat we expect to see here:\n\nDiscrete mixtures: Carbon pools scale approximately as the fractional (area) weighted average of the two monocultures.\nOverlap mixtures: Pools are dominated by the woody monoculture plus a modest incremental contribution from the annual component. \n\n\n\n\n\n\n\n\nEffect Size (Final Year AGB and SOC Compared to Annual Monoculture)\nThese plots show the change in carbon pool sizes for each mixture compared to the annual monoculture baselines. Because we are considering the healthy soils practice of adding a woody component like a hedgerow to an annual cropping system, we use annual monoculture as the point of comparison."
  },
  {
    "objectID": "docs/mixed_system_prototype.html#other-approaches-considered",
    "href": "docs/mixed_system_prototype.html#other-approaches-considered",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Other Approaches Considered",
    "text": "Other Approaches Considered\nWe evaluated several alternative approaches for representing mixed cropping systems:\n\nFractional coverage approach (mosaic / tiling) Each PFT is simulated separately and then combined by fractional area weighting (Li & Arora, 2011). This is the “Discrete” method described above (Equation 1).\nComposite PFT approach A new parameter set is defined to represent the mixture as a single “composite” PFT (e.g., DayCent: Parton et al., 1998).\n\nVegetation demography approach Individual or cohort based models explicitly represent competition for light and resources among PFTs, as well as disturbance and successional dynamics (Fisher et al., 2018).\n\nLimitations:\n\nComposite PFTs: By lumping mixture components into a single parameterization prevents explicit evaluation of the incremental contribution of individual PFTs - it would be harder to compare an orchard monoculture to an orchard+ground cover system. It can also bias estimates of pools and fluxes relative to the weighted mixture model (Li & Arora, 2011).\nFractional weighting: While more realistic, this approach requires careful treatment of long-lived pools (e.g., soil organic carbon, woody biomass). If the PFTs share a common soil, raw stocks cannot be summed without double-counting; instead, \\(\\Delta\\) stocks relative to a common baseline (or shared-pool formulations) should be aggregated - as is done in the “Overlap” method above (Equation 2).\nDemography models provide mechanistic representation of competition but impose higher computational costs and require additional data and parameterizations (Fisher et al., 2018; Fisher & Koven, 2020)."
  },
  {
    "objectID": "docs/mixed_system_prototype.html#references",
    "href": "docs/mixed_system_prototype.html#references",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "References",
    "text": "References\nCARB (2022). Draft 2022 Scoping Plan for Achieving Carbon Neutrality. https://ww2.arb.ca.gov/sites/default/files/2022-09/2022-draft-sp-appendix-b-draft-ea-recirc.pdf\nFisher and Koven, 2020. Perspectives on the future of land surface models and the challenges of representing complex terrestrial systems. JAMES 12, e2018MS001453. https://doi.org/10.1029/2018MS001453\nFisher et al., 2018. Vegetation demographics in Earth system models: a review of progress and priorities. Global Change Biol. 24, 35–54. https://doi.org/10.1111/gcb.13910\nLi, R., Arora, V.K., 2011. Effect of mosaic representation of vegetation in land surface schemes on simulated energy and carbon balances. https://doi.org/10.5194/bgd-8-5849-2011"
  },
  {
    "objectID": "docs/mixed_system_prototype.html#appendix",
    "href": "docs/mixed_system_prototype.html#appendix",
    "title": "Mixed-System Prototype (Two-PFT Aggregation)",
    "section": "Appendix",
    "text": "Appendix\n\nHealthy Soils Practices and Model Representation\n\n\nTable 3: Healthy Soils Program practices, model representation, and priority for implementation in SIPNET.\n\n\n\n\n\n\n\n\n\nAgronomic Practice\nModel Representation\nExpected GHG Impact on State GHG Inventory\nExpected Adoption (CARB 2022 Scoping Plan)\nPriority\n\n\n\n\nCover Crops\nPlanting/harvest like commodity; PFT/mixture params.\nHigh\nHigh\nHigh\n\n\nNon-Crop Carbon Amendments (manure/compost)\nAdd surface C & organic N (low C:N litter analog).\nHigh\nHigh\nHigh\n\n\nN Fertilization\nIncrease soil inorganic N pools.\nHigh\nHigh\nHigh\n\n\nTransition to Certified Organic\nComposite of shifts (fertility, amendments, tillage).\nHigh\nHigh\nHigh\n\n\nNo-till / Reduced till\nLower decomposition pulses (freq & magnitude).\nHigh\nMedium\nHigh\n\n\nPolycultures / Mixtures\nIndependent PFT runs; combine by fractional contribution.\nMedium\nMedium\nMedium\n\n\n(Water management placeholder)\nIncrease soil water content.\nHigh\n\n\n\n\nAnnual → Perennial\nChange PFT; partial biomass retained.\nHigh\nLow\nLow\n\n\nAgroforestry / Woody Buffers\nIndependent woody runs; spatial aggregation.\nHigh\nLow\nLow"
  }
]